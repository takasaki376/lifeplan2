# Jira チケット（F4）イベント編集：読み込み・更新（update）

## Summary

F4. イベント編集：読み込み・更新（update）— 既存イベントをロードして編集保存できる

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

F1（イベント一覧）と F3（イベント作成）が成立すると、次に必要なのは編集（update）。  
v0 で編集画面 UI は作成済み（または作成画面の流用）。MVP では IndexedDB 永続化のため、B5 の EventRepo を利用して、
既存イベントを読み込み、編集して更新保存できる状態を作る。

## Goal

- `/plans/[planId]/events/[eventId]/edit` で既存イベントが読み込まれ、フォームに反映される
- 編集して保存すると IndexedDB 上のイベントが更新される
- 保存後はイベント一覧へ戻り、更新内容が反映される
- 不正な eventId・読み込み失敗時に安全にフォールバックする

---

## In Scope

- 画面：`/plans/[planId]/events/[eventId]/edit`
- 読み込み：
  - `EventRepo.get(eventId)` でイベント取得
  - 取得結果をフォーム初期値に反映
- 更新：
  - F2 バリデーションを再利用して保存前検証
  - `EventRepo.update(updatedEvent)` の呼び出し
- UX：
  - ローディング表示（Skeleton）
  - 保存中 disabled/二重送信防止
  - 成功/失敗 toast
  - “変更があります” dirty 表示（任意だが推奨）
  - キャンセル導線：イベント一覧へ戻る
  - 変更ありで離脱時 confirm（任意）

## Out of Scope

- 複製（F5）
- 削除（F6）
- 将来見通しへの即時反映（I2）
- 高度な差分履歴（H 系）

---

## Functional Requirements

### 1) 初期ロード

- 画面マウント時：
  - `event = await EventRepo.get(eventId)`
- event が取得できない場合：
  - 表示：`イベントが見つかりません`
  - CTA：`イベント一覧へ戻る` → `/plans/[planId]/events`

### 2) フォーム反映

- 取得した event をフォーム state にセット
- 表示項目（作成画面と同等）：
  - title / eventType / startYm / cadence / durationMonths / amountYen / direction / note
- 作成画面と同じプレビュー（任意）も反映

### 3) 更新保存（update）

- 保存ボタン押下時：
  - `validateLifeEventDraft(draft)` を実行（F2）
  - invalid なら保存しない（エラー表示）
- valid なら以下を組み立て：
  - `updatedEvent = { ...event, ...draft, updatedAt: nowIso }`
  - id / planVersionId / createdAt は保持（編集で変えない）
- `await EventRepo.update(updatedEvent)`
- 成功時：
  - toast：`イベントを更新しました`
  - `router.push(/plans/[planId]/events)`
- 失敗時：
  - toast：`更新に失敗しました`
  - 画面に留まり入力保持

### 4) cadence 変更時の整合

- `cadence = once` に変更した場合：
  - durationMonths は 1 固定
- `cadence = monthly` の場合：
  - `durationMonths >= 1`（F2 ルール）

### 5) 読み込みと所属整合（任意だが推奨）

- URL の planId と event.planVersionId の整合は厳密チェックしない（MVP）  
  ただし安全策として、planId 不一致の疑いがあれば `一覧へ戻る` を促す UI を出しても良い。

---

## UI Requirements

- ヘッダー：
  - Breadcrumb：`プラン一覧 / {プラン名} / イベント / 編集`
  - Title：`イベントを編集`
  - Right actions：
    - `キャンセル` → `/plans/[planId]/events`
    - `保存`（primary）
- ローディング：フォーム Skeleton
- エラー：Alert + 戻るボタン
- 保存中：ボタン disabled + スピナー

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo：
  - `EventRepo.get(eventId)`
  - `EventRepo.update(event)`
- バリデーション：
  - F2 の `validateLifeEventDraft()` を共通利用
- 金額入力は `type="number"` 前提（カンマ除去は不要）
- dirty 判定（任意）：
  - 初期値と現在値を shallow compare（もしくは JSON stringify）で OK（MVP）

---

## Acceptance Criteria

- [ ] edit 画面で eventId を指定すると既存イベントが読み込まれフォームに表示される
- [ ] 値を変更して保存すると IndexedDB 上のイベントが更新される
- [ ] 保存後にイベント一覧へ戻り、更新内容が反映される
- [ ] バリデーションエラー時は保存されず、エラーが表示される（F2 再利用）
- [ ] 読み込み失敗/不正 eventId の時に安全にフォールバック（見つからない表示＋戻る導線）
- [ ] 保存中は二重送信できない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 正常：編集 → 保存 → 一覧反映
  - NG：必須欠落/金額 0/期間 0→ 保存されない
  - 不正 eventId→NotFound 表示
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（EventRepo 実装）
- F2（入力バリデーション）
- F1（一覧があると動作確認が容易）
- （推奨）A5（フォーマット/パース）

## Follow-ups（関連チケット）

- F5. イベント複製
- F6. イベント削除

# Jira チケット（E4）月次かんたん入力：前月コピー機能

## Summary

E4. 月次かんたん入力：前月コピー（前月の合計を当月へ複製して入力負担を軽減）

## Issue Type

Story（または Task）

## Priority

High（継続入力の体験を大きく改善）

## Background / Context

月次かんたん入力は継続入力が前提。多くの月は前月と大きく変わらないため、前月コピーがあると入力の手間が激減する。
MVP は IndexedDB 永続化のため、MonthlyRepo を利用して前月データを当月へ複製する。

## Goal

- 月次かんたん入力で「前月をコピー」できる
- 前月データが存在する場合、当月の入力欄に値が反映され、保存できる
- 前月データが無い場合、分かるメッセージを表示する
- 二重実行・誤操作を防ぐ（confirm/disabled/toast）

---

## In Scope

- 月次かんたん入力画面（current/指定月）に「前月をコピー」アクション追加
- Repo 連携（IndexedDB）
  - 前月 record の取得
  - 当月 record の upsert（作成/更新）
- コピー対象（MVP 最小）
  - incomeTotalYen
  - expenseTotalYen
  - assetsBalanceYen
  - liabilitiesBalanceYen
- UX
  - 実行前の軽い confirm（任意だが推奨：既存入力の上書き防止）
  - 成功/失敗 toast
  - 実行中 disabled（二重送信防止）
- 実行後、画面のフォーム state が更新される

## Out of Scope

- 月次詳細内訳（MonthlyItem）のコピー
- 複数月一括コピー
- 「前月差分の自動調整」（家賃/固定費など自動変化）

---

## Functional Requirements

### 1) 対象月と前月の決定

- 対象月：画面の `ym`（current の場合は currentYm）
- 前月：`prevYm(ym)`（"YYYY-MM"の前月を計算）
- util（A5 推奨）：`prevYearMonth(ym)` を使用

### 2) コピー処理（MVP）

- `prevRecord = MonthlyRepo.getByYm(planId, prevYm)`
- prevRecord が存在しない場合：
  - toast：`前月のデータがありません`
  - 何もしない
- prevRecord が存在する場合：
  - 当月へ upsert（上書き）：
    - `MonthlyRepo.upsertByYm(planId, ym, {
  incomeTotalYen: prevRecord.incomeTotalYen ?? 0,
  expenseTotalYen: prevRecord.expenseTotalYen ?? 0,
  assetsBalanceYen: prevRecord.assetsBalanceYen ?? 0,
  liabilitiesBalanceYen: prevRecord.liabilitiesBalanceYen ?? 0,
})`
  - 成功 toast：`前月の値をコピーしました`
  - フォーム入力欄をコピー後の値で更新（state 反映）

### 3) 上書きの安全策（推奨）

- 当月にすでに入力がある場合（record 存在 or フォームに値が入っている）：
  - confirm ダイアログ：
    - Title：`前月の値で上書きしますか？`
    - Description：`現在入力している内容は置き換えられます。`
    - Buttons：キャンセル / 上書きする（destructive or warning）
- 当月が未入力の場合は confirm 省略しても OK

### 4) ローディング/エラー

- 実行中はボタン disabled + spinner
- 失敗時：
  - toast：`コピーに失敗しました`
  - 入力は維持

---

## UI Requirements

- v0 モックに準拠
- 配置：
  - ヘッダー右 or フッターのアクション列に `前月をコピー`（secondary）
  - 保存ボタンとは分ける（誤タップ防止）
- モバイルでも押しやすい
- confirm は `AlertDialog`（shadcn/ui）

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo：
  - `MonthlyRepo.getByYm(planId, prevYm)`
  - `MonthlyRepo.upsertByYm(planId, ym, patch)`
  - （任意）Repo に `copyFromPreviousMonth(planId, ym)` を追加して UI を薄くする
- util（A5）：
  - `getCurrentYearMonth()`
  - `prevYearMonth(ym)`
- コピー後は
  - state 更新（フォーム入力値をセット）
  - もしくは当月 record 再取得して反映

---

## Acceptance Criteria

- [ ] 月次かんたん入力に「前月をコピー」ボタンがある
- [ ] 前月データがある場合、当月へ合計 4 項目がコピーされフォームに反映される
- [ ] 前月データが無い場合、toast で通知され何も変わらない
- [ ] 当月に既存入力がある場合、confirm で上書き確認ができる（採用した場合）
- [ ] 実行中は二重送信できない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載
  - 前月あり → コピー → 保存
  - 前月なし →toast
  - 当月入力済み →confirm→ 上書き
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（MonthlyRepo 実装）
- E3（月次かんたん入力：読み込み・保存）
- A5（年月ユーティリティ：推奨）

## Follow-ups（関連チケット）

- E4+ 月次詳細内訳（MonthlyItem）も前月からコピー
- E2（月次一覧の行アクションから前月コピーを呼ぶ）

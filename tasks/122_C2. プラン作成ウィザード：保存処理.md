# Jira チケット（C2）プラン作成ウィザード：保存処理（create plan + 初期 version 作成）

## Summary

C2. プラン作成ウィザード：保存処理（create plan + 初期 version 作成）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

v0 で「プラン作成（かんたんウィザード）」画面の UI モックは作成済み。  
MVP では IndexedDB で永続化するため、B5 の Repository（PlanRepo/VersionRepo ほか）を使って、ウィザード完了時に以下を一括作成する。

- Plan（プラン本体）
- 初期 PlanVersion（v1 / isCurrent=true）
- 初期前提データ（C3 で投入するが、C2 で呼び出す or C2 で最低限作る方針を明確化）

このチケットは「ウィザードで入力した情報が DB に保存され、ダッシュボードへ遷移できる」状態を作る。

## Goal

- ウィザード完了で Plan を作成できる
- 同時に初期 Version（v1）を作成し、現行版として設定できる
- 作成後に `/plans/[planId]`（ダッシュボード）へ遷移できる
- 途中離脱/入力不足の扱い（必須最小）を定める

---

## In Scope

- 画面：`/plans/new`（プラン作成ウィザード）
- 入力値の取り出し（Step1〜3）
  - プラン名（必須）
  - 世帯構成（任意）
  - 備考（任意）
  - 住宅タイプ（必須）※選択状態は HousingAssumptions の isSelected に反映
  - 初期サマリー（収入/資産/負債など：任意、保存するなら MonthlyRecord へ）
- 保存処理（基本は 1 ボタン）
  - PlanRepo.create
  - VersionRepo（初期 version 作成：v1, isCurrent=true）
  - （方針 A）C3 の初期前提投入を呼ぶ（推奨）
  - （方針 B）C2 内で最低限の初期前提を作る（3 シナリオ・4 住宅の枠だけ）
- 保存完了後の遷移：`/plans/[planId]`
- toast：成功/失敗

## Out of Scope

- 初期前提の具体値（プリセット値）の設計（C3）
- 月次入力の詳細（E3 以降）
- 認証/ユーザー紐付けの厳密化（MVP では userId は optional）
- プラン作成中のドラフト保存（将来）

---

## Functional Requirements

### 1) 必須入力

- プラン名：必須
- 住宅タイプ：必須（高性能住宅 / 一般戸建 / 分譲マンション / 賃貸）

### 2) 作成されるデータ（最小）

- Plan
  - name, householdType?, note?
  - status = active
  - createdAt/updatedAt
- PlanVersion（初期）
  - planId
  - versionNo = 1
  - isCurrent = true
  - changeNote = "初期作成"（任意）
  - createdAt

### 3) 初期前提データの扱い（実装方針を決める）

**推奨：方針 A**

- C2 は「Plan + Version 作成」までを責務とし、
- 初期前提投入は C3 の関数（usecase）を呼ぶ
  - scenarioAssumptions（3 件）
  - housingAssumptions（4 件 + 選択タイプ isSelected=true）
  - lifeEvents（0 件）

**代替：方針 B（MVP 最短）**

- C2 内で最低限の枠だけ作成（値は空でもよい）
  - scenarioAssumptions：3 件（rate は未設定でも OK）
  - housingAssumptions：4 件（初期費用/ローン等は未設定でも OK）
  - 選択した住宅タイプだけ isSelected=true

> どちらの方針でも「作成直後に LCC 画面を開ける」状態にする。

### 4) Step3 の「初期サマリー」保存（任意）

- Step3 で入力された
  - 世帯年収（手取り概算）
  - 資産残高
  - 負債残高
    を保存する場合：
- “今月”の MonthlyRecord として `MonthlyRepository.upsertByYm(planId, currentYm, ...)` で保存
- 入力が空なら作らない（または undefined で作る）

※MVP では「空でも完了できる」を優先するため、**保存は任意**でよい。

### 5) 失敗時

- Plan 作成に失敗したら中断し、toast で通知
- Plan は作れたが Version 作成に失敗した場合：
  - 可能ならロールバック（tx 相当）
  - IndexedDB レベルで跨 store tx が可能なら、Plan+Version は同 tx で実行（推奨）
- 最低でも不整合が残らないようにする

---

## Technical Notes

- `"use client"` で実装（IndexedDB 利用）
- Repo 利用：
  - `PlanRepository.create(...)`
  - `VersionRepository.createInitial(...)`（無ければ `createFromCurrent` ではなく専用メソッドを用意してもよい）
  - （任意）`HousingRepository.setSelected(planVersionId, type)`
  - （任意）`MonthlyRepository.upsertByYm(...)`
- 複数操作はトランザクションでまとめる（可能なら）
- 成功後に `router.push(`/plans/${plan.id}`)`

---

## Acceptance Criteria

- [ ] プラン名を入力し、ウィザード完了で Plan が作成される
- [ ] 同時に初期 PlanVersion（v1）が作成され、isCurrent=true になる
- [ ] 選択した住宅タイプが「選択中（isSelected）」として保存される（方針 A/B いずれか）
- [ ] 保存後に `/plans/[planId]` へ遷移できる
- [ ] Step3 が空でも完了できる
- [ ] 失敗時に toast が出て、致命的不整合（Plan だけ作られて Version が無い等）が極力残らない

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載（例：作成 → 一覧に出る → ダッシュボード遷移）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（PlanRepo / VersionRepo / HousingRepo / MonthlyRepo）
- （推奨）C3（初期前提投入を呼ぶ場合）

## Follow-ups（関連チケット）

- C3. 初期デフォルト前提投入（3 シナリオ、住宅 4 タイプ）
- C1. プラン一覧への反映確認（作成後に表示される）
- D1. ダッシュボードで currentVersion を参照して表示

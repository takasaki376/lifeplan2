# Jira チケット（G1-1）住宅 LCC 比較トップ：scenario 適用（URL クエリ連動で計算結果切替）

## Summary

G1-1. 住宅 LCC 比較トップ：scenario 適用（D7 と同一 URL クエリ仕様で合計/内訳を切替）

## Issue Type

Task（または Story）

## Priority

Medium-High（シナリオ比較の一貫性確保。D5 と揃える）

## Background / Context

D7 でダッシュボードのシナリオ切替（URL クエリ `scenario`）を導入し、D5 で LCC サマリーがシナリオに追従するようにした。
同じ体験を住宅 LCC 比較トップ（G1）にも適用し、ダッシュボードと同一のシナリオ前提で 4 タイプ比較ができるようにする。

## Goal

- `/plans/[planId]/housing` で URL クエリ `scenario` に応じて表示値（合計/内訳）が切り替わる
- 不正/未指定 `scenario` は base にフォールバックする
- シナリオラベル（保守/標準/楽観）が画面に表示される
- D5 と同じクエリ仕様・同じ前提取得の流れで統一される

---

## In Scope

- 画面：`/plans/[planId]/housing`（G1）
- URL クエリ `scenario` の読み取り・パース
  - `scenario=conservative|base|optimistic`
  - 未指定/不正 → base
- シナリオ前提の取得
  - `ScenarioRepo.getByVersion(planVersionId)`（または Version 内包）
- 4 タイプ各カードの計算に `scenarioAssumptions` を渡す
  - G9 の `calcLcc()` / `calcLccSummary()` 呼び出しに追加引数として適用
- UI 表示
  - 現在の前提：`保守/標準/楽観` を表示（ヘッダー or サブヘッダー）
  - （任意）シナリオ切替 UI（D7 同等）を G1 にも置く or 「ダッシュボードで切替」導線
- エラー/不足時のフォールバック
  - scenarioSet が無い → base 相当のデフォルトで表示＋ warning

## Out of Scope

- シナリオ前提編集（別チケット）
- 同時に複数シナリオを並列表示する比較
- NPV/割引率など高度な比較（将来）

---

## Functional Requirements

### 1) scenario の解決（D7 と同一）

- `selectedScenario = parseScenario(searchParams.get("scenario"))`
- parse ルール：
  - conservative/base/optimistic のみ許可
  - 未指定/不正 → base

### 2) 前提取得

- `currentVersion = VersionRepo.getCurrent(planId)`
- `housingList = HousingRepo.listByVersion(currentVersion.id)`
- `scenarioSet = ScenarioRepo.getByVersion(currentVersion.id)`（または Version 内包）
- `scenarioAssumptions = scenarioSet[selectedScenario]`
- scenarioSet が無い/不足：
  - `scenarioAssumptions = defaultBaseScenario`
  - warning 表示：`シナリオ前提が不足しています（標準で表示）`

### 3) 計算への適用（4 タイプすべて）

- 4 タイプカードそれぞれで：
  - `result = calcLcc({ housingAssumptions: typeAssumptions, scenarioAssumptions, horizonMonths })`
  - 合計/内訳表示は従来 G1 の仕様通り
- G9 未実装の場合：
  - 合計/内訳はプレースホルダ
  - シナリオラベルだけは切替に追従

### 4) 画面表示

- ヘッダー付近に表示：
  - `前提：保守/標準/楽観`
- （任意）切替 UI を G1 にも置く場合：
  - D7 と同じ `scenario` クエリ更新方式を採用（replace 推奨）
  - 置かない場合は、説明テキスト：
    - `ダッシュボードのシナリオ切替（URL scenario）に連動します`

### 5) URL 共有・遷移整合

- D5 → G1（`住宅LCC比較へ`）の遷移時に、現在の `scenario` を引き継ぐ（任意だが推奨）
  - 例：`/plans/[planId]/housing?scenario=base`
    ※この引き継ぎは D5 側のリンク生成で対応しても OK（別サブタスクでも可）

---

## UI Requirements

- v0 モック準拠（4 カード）
- シナリオラベルが常に見える
- ローディング：Skeleton
- エラー：Alert（画面全体 or カード単位）

---

## Technical Notes

- `"use client"`
- util 共通化（推奨）
  - `src/lib/scenario.ts`
    - `ScenarioKey` / `parseScenario`
- Repo
  - `VersionRepo.getCurrent(planId)`
  - `HousingRepo.listByVersion(planVersionId)`
  - `ScenarioRepo.getByVersion(planVersionId)`（または Version 内包）
- 計算
  - `calcLcc` / `calcLccSummary` のシグネチャに `scenarioAssumptions` を含める（G9 側と整合）

---

## Acceptance Criteria

- [ ] G1 画面で URL `scenario` に応じて表示が切り替わる（少なくともラベルは切替）
- [ ] `scenario` 未指定/不正値で base にフォールバックする
- [ ] 4 タイプすべての計算に同一 `scenarioAssumptions` が適用される（G9 連携時）
- [ ] scenarioSet 不足時に base デフォルトで表示し、warning が出る
- [ ] D5→G1 遷移で scenario が引き継がれる（採用した場合）
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - scenario=base/conservative/optimistic での切替
  - 不正 scenario で base フォールバック
  - scenario 前提不足ケース
- [ ] lint/typecheck が通る

---

## Dependencies

- G1（比較トップのベース実装）
- D7（scenario クエリ仕様の確定）
- B5（VersionRepo / HousingRepo）
- （推奨）ScenarioRepo（または Version 内包の前提取得）
- （任意）G9（数値が変わることの検証用）

## Follow-ups

- D5→G1 リンクの scenario 引き継ぎを全導線に適用（dashboard 以外も含む）
- G5（住宅前提編集）も同じ scenario 表示・切替方針に統一

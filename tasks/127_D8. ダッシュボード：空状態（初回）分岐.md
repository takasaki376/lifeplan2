# Jira チケット（D8）ダッシュボード：空状態（初回）分岐

## Summary

D8. ダッシュボード：空状態（初回）分岐（初回ユーザー/初回プランの導線整備）

## Issue Type

Story（または Task）

## Priority

High（ダッシュボードの“何をすればいいか分からない”を潰す）

## Background / Context

v0 でダッシュボード UI モックは作成済み。  
MVP では IndexedDB を永続化として、プラン作成直後や月次未入力・前提未設定など、データが揃っていない状態が頻出する。

初回状態で“空のカードが並ぶだけ”になると離脱しやすいので、状態に応じた**空状態分岐**と**最短 CTA**を整備する。

## Goal

- ダッシュボードがデータ欠損時でも破綻せず、次にやることが明確になる
- 初回（何も入力されていない）でも、月次入力・住宅 LCC・イベント追加へ迷わず遷移できる
- 空状態からの作業導線が「継続入力 → 前提調整 → 見直し」に沿う

---

## In Scope

- ダッシュボード `/plans/[planId]` の空状態分岐ロジック実装
- Repository からの取得結果に応じて表示を切り替える
- 空状態カード（オンボーディング）と CTA の実装
- “次にやること”チェックリスト（最低限 3 つ）の表示

## Out of Scope

- ダッシュボードの全 KPI 集計精度向上（D3/D5 など）
- LCC 計算ロジック自体（G9）
- 将来見通し画面（I 系）
- バージョン差分画面（H 系）

---

## Data Dependencies（参照するデータ）

以下を取得して空状態判定する（存在しない場合もあり得る）：

- Plan（PlanRepo.get）
- Current Version（VersionRepo.getCurrent）
- 当月 MonthlyRecord（MonthlyRepo.getByYm(planId, currentYm)）
- 住宅前提（HousingRepo.listByVersion(planVersionId) / get selected）
- イベント（EventRepo.listByVersion(planVersionId, scope="upcoming", limit=3 相当 ※無ければ全件取得して slice でも OK）

---

## Empty State Definitions（状態定義）

最低限、以下の状態分岐を実装する（優先度順）。

### State 0：Plan が存在しない/取得失敗

- 表示：エラー/Not Found
- CTA：`プラン一覧へ戻る`

### State 1：初回（当月 MonthlyRecord が存在しない）

- 主表示：Onboarding Card（大きめ）
  - タイトル：`まずは今月の合計を入力しましょう`
  - 説明：`正確でなくてOK。あとから修正できます。`
- CTA（Primary）：`今月を入力` → `/plans/[planId]/months/current`
- CTA（Secondary）：`月次一覧を見る` → `/plans/[planId]/months`

### State 2：住宅前提が未設定（housingAssumptions が 0 件 もしくは 4 タイプ不足）

- 表示：注意カード
  - `住宅LCC比較を使うには前提の設定が必要です`
- CTA：`住宅前提を設定` → `/plans/[planId]/housing/assumptions`
- 補助：`比較トップへ` → `/plans/[planId]/housing`（空でも誘導）

### State 3：住宅タイプ未選択（4 件はあるが isSelected が無い）

- 表示：注意カード
  - `比較する住宅タイプを選択しましょう`
- CTA：`住宅LCC比較へ` → `/plans/[planId]/housing`

### State 4：イベントが 0 件

- 表示：提案カード
  - `イベントを追加すると見通しが良くなります`
- CTA：`イベントを追加` → `/plans/[planId]/events/new`
- Secondary：`イベント一覧` → `/plans/[planId]/events`

### State 5：すべて揃っている（通常状態）

- 通常のダッシュボード表示（既存モック通り）
- “次にやること”は未完タスクがあれば表示

---

## UI Requirements（v0 モックに追加する/調整する要素）

- 上部に「初回オンボーディングカード」を差し込める枠
- “次にやること”チェックリスト（最大 3〜5）
  - 今月を入力
  - 住宅前提を設定
  - 住宅タイプを選択
  - イベントを追加
- 各項目にステータス（未完/完了）と CTA ボタン
- ローディング中：Skeleton or `読み込み中...`
- エラー時：Alert + `プラン一覧へ戻る`

---

## Technical Notes

- `"use client"` で実装（IndexedDB）
- 判定に必要な `currentYm` は共通 util（A5）で生成
- 取得は並列（Promise.all）で OK、必要最低限の回数に抑える
- EventRepo に limit が無ければ全件 → ソート →slice（MVP で OK）
- 画面内の状態管理例：
  - `isLoading`
  - `error`
  - `dashboardState`（"FIRST_TIME" | "NEEDS_HOUSING" | "NEEDS_SELECTION" | "NEEDS_EVENTS" | "READY"）

---

## Acceptance Criteria

- [ ] Plan が取得できない場合に安全にフォールバックする（NotFound/戻る導線）
- [ ] 当月未入力の場合、オンボーディングカードが表示され `今月を入力` に遷移できる
- [ ] 住宅前提が未設定/不足の場合、前提設定 CTA が表示される
- [ ] 住宅タイプ未選択の場合、比較トップへ誘導される
- [ ] イベント 0 件の場合、イベント追加 CTA が表示される
- [ ] 通常状態では既存のダッシュボード表示に戻る
- [ ] ローディング/エラー時の表示がある
- [ ] toast/遷移が破綻しない

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載（初回/住宅未設定/イベントなし/通常）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（各 Repo の実装：Plan/Version/Monthly/Housing/Event）
- A5（currentYm 生成・フォーマット util）※任意だが推奨
- D1/D2（基本表示がある程度存在することが望ましい）

## Follow-ups（関連チケット）

- D4. 次にやることチェックリスト（内容拡充）
- D5. 住宅 LCC サマリーカード（選択中タイプの表示）
- F1/F2. イベント機能の実装完了
- E3. 月次かんたん入力の保存

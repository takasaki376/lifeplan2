# Jira チケット（D4）ダッシュボード：次にやることチェックリスト（未入力・イベント未登録等の判定）

## Summary

D4. ダッシュボード：次にやることチェックリスト（未入力・イベント未登録等の判定）

## Issue Type

Story（または Task）

## Priority

High（“何からやればいいか”を明確化し、継続入力を促進する）

## Background / Context

ダッシュボードは MVP のハブ画面。初回やデータ欠損時に、ユーザーが次にやるべき操作（今月入力、住宅前提設定、イベント追加など）を迷わず実行できるように、
状態に応じた「次にやること」チェックリストを表示する。

D8（空状態分岐）があっても、通常状態でも未完タスクは残り得るため、D4 は常設で価値がある。

## Goal

- ダッシュボードに「次にやること」チェックリストを表示できる
- Repository から取得した状態に基づき、未完/完了を判定できる
- 各項目に最短 CTA を付け、該当画面へ遷移できる
- “初回だけ”ではなく、運用中も役立つ（未入力月、イベント追加など）

---

## In Scope

- 画面：`/plans/[planId]`（ダッシュボード）
- チェックリスト UI（カード/リスト）実装（v0 モックに合わせる）
- 判定ロジック（未完/完了）を関数化して実装
- CTA（各項目のボタン/リンク）実装
- ローディング/エラー時の扱い（最小）

## Out of Scope

- KPI 集計・チャートの精度向上（D3/D5）
- 住宅 LCC 計算（G9）
- 将来推移の本格表示（I 系）
- チェックリストのユーザー個別カスタム（将来）

---

## Checklist Items（項目定義：MVP 版）

※最大 3〜5 件を表示。未完を優先し、完了は折りたたみでも可。

### Item A：今月を入力（最優先）

- 判定：
  - `MonthlyRepo.getByYm(planId, currentYm)` が存在しない → 未完
  - 存在する → 完了
- CTA：
  - 未完：`今月を入力` → `/plans/[planId]/months/current`
  - 完了：`今月を編集` → `/plans/[planId]/months/current`
- 補助表示（任意）：`currentYm`（例：2026 年 1 月）

### Item B：住宅前提を設定（LCC 比較の準備）

- 判定（MVP の簡易ルール）：
  - `HousingRepo.listByVersion(planVersionId)` が 4 件未満 → 未完（未設定/不足）
  - 4 件以上 → 完了
- CTA：
  - `住宅前提を設定` → `/plans/[planId]/housing/assumptions`

### Item C：住宅タイプを選択（比較の軸）

- 判定：
  - housingAssumptions は揃っている前提で、`isSelected=true` のものが存在しない → 未完
  - 存在する → 完了
- CTA：
  - `住宅LCC比較へ` → `/plans/[planId]/housing`

### Item D：イベントを追加（見通しの質を上げる）

- 判定：
  - `EventRepo.listByVersion(planVersionId, { scope: "all" })` の件数が 0 → 未完
  - 1 件以上 → 完了
- CTA：
  - `イベントを追加` → `/plans/[planId]/events/new`
  - Secondary：`イベント一覧` → `/plans/[planId]/events`

### Item E（任意）：改定メモを残す（見直し運用）

- 判定：
  - currentVersion.changeNote が空 → 未完（任意）
- CTA：
  - `改定履歴を見る` → `/plans/[planId]/versions`
    ※MVP では優先度低。入れるなら 5 件目で OK。

---

## Data Fetch / 判定フロー

- 取得（並列で OK）：
  - `plan = PlanRepo.get(planId)`（D1 で取得済みなら流用）
  - `currentVersion = VersionRepo.getCurrent(planId)`（D1 で取得済みなら流用）
  - `currentMonthly = MonthlyRepo.getByYm(planId, currentYm)`（D2 で取得済みなら流用）
  - `housingList = HousingRepo.listByVersion(currentVersion.id)`
  - `events = EventRepo.listByVersion(currentVersion.id, { scope: "all" })`
- 判定は `computeNextActions({ currentYm, currentMonthly, housingList, events, currentVersion })` のように関数化

---

## UI Requirements

- チェックリストカード（例：タイトル「次にやること」）
- 各行：
  - チェックアイコン（完了/未完）
  - タイトル
  - 補足（任意：対象月、件数など）
  - CTA ボタン（Primary/Secondary）
- 表示ルール：
  - 未完を上に並べる
  - 未完が 0 件なら「やることはありません」+ 主要導線（住宅/イベント/月次一覧）を表示（任意）
- ローディング：Skeleton
- エラー：小さめ Alert（他のカードに影響させない）

---

## Technical Notes

- `"use client"`（IndexedDB）
- util（A5 推奨）：
  - `getCurrentYearMonth()`
  - `formatYearMonth(ym)`
- 依存：D1/D2 がすでに取得しているデータは再取得しない（可能なら props/state で共有）
- EventRepo に limit が無ければ全件 →count で OK（MVP）

---

## Acceptance Criteria

- [ ] ダッシュボードに「次にやること」チェックリストが表示される
- [ ] 今月未入力の場合、「今月を入力」が未完で表示され、CTA で遷移できる
- [ ] 住宅前提が不足の場合、「住宅前提を設定」が未完で表示され、CTA で遷移できる
- [ ] 住宅タイプ未選択の場合、「住宅 LCC 比較へ」が未完で表示され、CTA で遷移できる
- [ ] イベント 0 件の場合、「イベントを追加」が未完で表示され、CTA で遷移できる
- [ ] 各項目が完了条件を満たすと、完了表示に切り替わる
- [ ] ローディング/エラー時の表示がある（チェックリスト枠のみ）
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 今月未入力 → 入力後に完了へ
  - 住宅前提未設定 → 設定後に完了へ
  - イベント 0 件 → 追加後に完了へ
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（Repo：Monthly/Housing/Event/Version）
- D1（plan/currentVersion 取得）
- D2（今月ステータス判定：取得結果を流用できる）
- （推奨）A5（年月・フォーマット）

## Follow-ups

- D8（空状態分岐）と表示優先度の整理（重複を避ける）
- D5（住宅 LCC サマリーカード）と連動して「未選択」判定を強化

# Jira チケット C2: プラン作成ウィザード：保存処理（create plan + 初期 version 作成）

## Summary

C2. プラン作成ウィザード：保存処理（create plan + 初期 version 作成）

## Issue Type

Story / Task

## Priority

High

## Background / Context

v0 で「プラン作成（かんたんウィザード）」画面の UI モックは作成済み。  
MVP では IndexedDB で永続化するため、B5 の Repository（PlanRepo/VersionRepo ほか）を使って、
ウィザード完了時に以下を一括作成する。

- Plan（プラン本体）
- 初期 PlanVersion（v1 / isCurrent=true）
- 初期前提は C3 の usecase を呼び出す（方針A）

このチケットでは「ウィザードで入力した情報が DB に保存され、ダッシュボードへ遷移できる」状態を作る。

## Goal

- ウィザード完了時に Plan を作成できる
- 同時に初期 Version（v1）を作成し、現行版として設定できる
- 作成後に `/plans/[planId]`（ダッシュボード）へ遷移できる
- 途中離脱/入力不足の扱いは最小限に留める

---

## In Scope

- 画面: `/plans/new`（プラン作成ウィザード）
- 入力値の取り出し
  - プラン名（必須）
  - 世帯構成（任意）
  - 備考（任意）
  - 住宅タイプ（必須）  
    `high_performance_home | detached | condo | rent`
  - 初期サマリー（任意）
    - 世帯年収（手取り概算）
    - 資産残高
    - 負債残高
- 保存処理（1 ボタン）
  - PlanRepo.create
  - VersionRepo.createInitial（v1, isCurrent=true）
  - C3 の初期前提投入 usecase を呼び出す（推奨）
- 保存完了後に `/plans/[planId]` へ遷移
- toast による成功/失敗通知

### 初期サマリーの保存先

- MonthlyRecord には保存しない
- PlanVersion に以下を保存する
  - `incomeMonthlyYen`（年収を月額換算）
  - `assetsBalanceYen`
  - `liabilitiesBalanceYen`

---

## Out of Scope

- 初期前提の具体値（初期投入は C3 で定義）
- 月次入力詳細（E3 以降）
- 認証/ユーザー紐付けの厳密化（MVP では userId は optional）
- 作成途中のドラフト保存

---

## Functional Requirements

### 1) 必須項目

- プラン名：必須
- 住宅タイプ：必須

### 2) 作成されるデータ（最小）

- Plan
  - name, householdType?, note?
  - status = active
  - createdAt/updatedAt
- PlanVersion（初期）
  - planId
  - versionNo = 1
  - isCurrent = true
  - changeNote = "初期作成"（任意）
  - incomeMonthlyYen / assetsBalanceYen / liabilitiesBalanceYen（任意）
  - createdAt

### 3) 初期前提データの扱い（方針A）

- C2 は「Plan + Version 作成」までが責務
- 初期前提投入は C3 の usecase を呼ぶ
  - scenarioAssumptions 3 件
  - housingAssumptions 4 件 + 選択タイプ isSelected=true
  - lifeEvents 0 件（C3 では作成しない）

> 直後に LCC 画面が開ける状態を作る

### 4) 失敗時

- Plan 作成に失敗したら中断し、toast で通知
- Plan は作れたが Version 作成に失敗した場合
  - 可能ならロールバック（tx）で整合性を保つ
- できる限り不整合（Plan だけ作られて Version が無い）を残さない

---

## Technical Notes

- `"use client"` で IndexedDB を利用
- Repo 利用
  - `PlanRepository.create(...)`
  - `VersionRepository.createInitial(...)`
  - `initializePlanVersionDefaults(...)`（C3 の usecase）
- 複数操作はトランザクションでまとめる（可能なら）
- 成功後に `router.push(`/plans/${plan.id}`)`

---

## Acceptance Criteria

- [ ] プラン名を入力し、ウィザード完了時に Plan が作成される
- [ ] 同時に初期 PlanVersion（v1）が作成され、isCurrent=true になる
- [ ] 選択した住宅タイプが isSelected=true として保存される（C3 経由）
- [ ] 保存後に `/plans/[planId]` へ遷移できる
- [ ] Step3 が空でも完了できる
- [ ] 失敗時に toast が出て、不整合が極力残らない

## Definition of Done

- [ ] PR 作成〜レビュー完了
- [ ] 手動テスト手順を PR に記載（作成 → 一覧 → ダッシュボード遷移）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（PlanRepo / VersionRepo / HousingRepo）
- C3（初期前提投入 usecase）

## Follow-ups / 関連チケット

- C3. プラン作成：初期デフォルト前提投入（シナリオ、住宅4タイプ）
- C1. プラン一覧への反映確認
- D1. ダッシュボードで currentVersion を参照して表示

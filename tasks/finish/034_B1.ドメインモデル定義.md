# Jira チケット（B1）ドメインモデル定義（TypeScript 型）

## Summary

B1. ドメインモデル定義（TypeScript 型：Plan / Version / MonthlyRecord / LifeEvent / HousingAssumptions）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

MVP は IndexedDB で永続化するが、将来的に Supabase へ移行する前提のため、アプリ全体で共通に使う「ドメインモデル（型）」を先に確定する。  
UI（v0 生成）と Repository 層（B4 以降）の契約の基盤になる。

## Goal

- UI・計算・永続化で共通に利用する TypeScript 型を定義する
- IndexedDB の objectStore 設計に耐える「ID・月キー・版（Version）」の粒度を揃える
- 将来 Supabase 移行時も破綻しないよう、DB 依存を型から切り離す（Repository で吸収）

## In Scope

- TypeScript の型定義（interfaces/types）
- enum 相当の literal union 定義
- 日付の正規化ルール（MonthKey 等）の型レベル表現
- MVP に必要な最小フィールドの確定
- `type_specific` の JSON 構造（最低限）を型で表現（Zod は J1 で別チケット）

## Out of Scope

- IndexedDB 実装（B3/B5）
- Supabase 実装（B6）
- 計算ロジック実装（LCC/将来推移）
- 画面実装

## Deliverables

- `src/lib/domain/types.ts`（または `src/lib/domain/*.ts`）に以下の型を定義
  - `Plan`
  - `PlanVersion`
  - `ScenarioKey` / `ScenarioAssumptions`
  - `MonthlyRecord`
  - `MonthlyItem`（詳細内訳：任意だが型は定義）
  - `LifeEvent`
  - `HousingType` / `HousingAssumptions`（4 タイプ + type-specific）
  - 共通：`Id`, `ISODate`, `YearMonth`, `MoneyYen` など（必要に応じて）

## Design Notes（型設計方針）

- ID は `string`（uuid 文字列想定）。生成方法は別レイヤーで。
- 月は `YearMonth`（例 `"2026-01"`）を採用し、UI/DB キーに使う  
  ※必要なら `monthStartISO: "2026-01-01"` を派生として計算で作る
- 実績（月次）は Plan 直下（改定 Version に依存しない）
- 前提（シナリオ/住宅/イベント）は Version 配下（差分比較対象）
- 住宅のタイプ固有前提は union + `typeSpecific` で拡張可能にする

## Acceptance Criteria

- [ ] 型定義ファイルが追加され、UI 層から import 可能
- [ ] `ScenarioKey` は `conservative | base | optimistic` で定義
- [ ] `HousingType` は `high_performance_home | detached | condo | rent` で定義
- [ ] `YearMonth` を採用し、月次とイベントの startMonth に利用
- [ ] `HousingAssumptions` は 4 タイプの union とし、タイプ固有項目が型で表現されている
- [ ] `MonthlyRecord` は「かんたん入力の 4 ボックス」を表現できる
- [ ] `LifeEvent` は「単発/毎月」「期間」「支出/収入」を表現できる
- [ ] `PlanVersion` で `isCurrent` と `versionNo` を持てる
- [ ] TS エラーなくビルドできる（少なくとも型定義が循環しない）

## Definition of Done

- [ ] PR が作成され、型の命名/粒度/必須項目についてレビュー完了
- [ ] README または簡易コメントで「MonthKey の扱い」と「実績/前提の境界」が記載されている

## Suggested Implementation（雛形：コピペ可）

> ※チケット本文に貼るための参考。実装は本チケットの成果物。

```ts
// src/lib/domain/types.ts

export type Id = string; // uuid string
export type YearMonth = `${number}-${string}`; // e.g. "2026-01" (enforce via runtime validation later)
export type MoneyYen = number; // MVP: integer yen (use number). If needed switch to bigint/decimal later.

export type ScenarioKey = "conservative" | "base" | "optimistic";
export type HouseholdType = "single" | "couple" | "couple_kids" | "other";

export interface Plan {
  id: Id;
  userId?: Id;
  name: string;
  householdType?: HouseholdType;
  note?: string;
  status: "active" | "archived";
  createdAt: string; // ISO
  updatedAt: string; // ISO
  archivedAt?: string; // ISO
  currentVersionId?: Id; // convenience pointer (source of truth can be versions)
}

export interface PlanVersion {
  id: Id;
  planId: Id;
  versionNo: number;
  title?: string;
  changeNote?: string;
  isCurrent: boolean;
  createdAt: string; // ISO
}

export interface ScenarioAssumptions {
  id: Id;
  planVersionId: Id;
  scenarioKey: ScenarioKey;
  wageGrowthRate?: number; // 0.02
  inflationRate?: number; // 0.01
  investmentReturnRate?: number; // 0.03
  createdAt: string; // ISO
}

export interface MonthlyRecord {
  id: Id;
  planId: Id;
  ym: YearMonth; // month key
  incomeTotalYen?: MoneyYen;
  incomeMainYen?: MoneyYen;
  incomeSideYen?: MoneyYen;
  expenseTotalYen?: MoneyYen;
  expenseFixedYen?: MoneyYen;
  expenseVariableYen?: MoneyYen;
  assetsBalanceYen?: MoneyYen;
  liabilitiesBalanceYen?: MoneyYen;
  memo?: string;
  isFinalized: boolean;
  createdAt: string;
  updatedAt: string;
}

export type MonthlyItemKind = "income" | "expense";

export interface MonthlyItem {
  id: Id;
  monthlyRecordId: Id;
  kind: MonthlyItemKind;
  category: string; // keep flexible
  amountYen: MoneyYen;
  note?: string;
  sortOrder?: number;
}

export type EventCadence = "once" | "monthly";
export type EventDirection = "expense" | "income";

export interface LifeEvent {
  id: Id;
  planVersionId: Id;
  eventType: string; // "education" etc (keep flexible)
  title?: string;
  startYm: YearMonth;
  cadence: EventCadence;
  durationMonths?: number; // required for monthly in UI, optional at type level
  amountYen: MoneyYen;
  direction: EventDirection;
  note?: string;
  createdAt: string;
  updatedAt: string;
}

export type HousingType = "high_performance_home" | "detached" | "condo" | "rent";
export type RepaymentType = "annuity" | "equal_principal";

export interface HousingCommonAssumptions {
  id: Id;
  planVersionId: Id;
  housingType: HousingType;
  isSelected: boolean;

  initialCostYen?: MoneyYen;
  downPaymentYen?: MoneyYen;
  closingCostYen?: MoneyYen;

  loanPrincipalYen?: MoneyYen;
  loanInterestRate?: number; // 0.012
  loanTermMonths?: number; // 420
  repaymentType?: RepaymentType;

  propertyTaxAnnualYen?: MoneyYen;

  utilitiesBaseMonthlyYen?: MoneyYen;
  utilitiesFactor?: number; // 0.85

  createdAt: string;
  updatedAt: string;
}

export interface RepairsScheduleItem {
  cycleYears: number;
  amountYen: MoneyYen;
}

export interface HighPerformanceHomeAssumptions extends HousingCommonAssumptions {
  housingType: "high_performance_home";
  typeSpecific?: {
    insulationGrade?: string; // e.g. "HEAT20-G2"
    solarCapacityKw?: number;
  };
  repairsSchedule?: RepairsScheduleItem[];
}

export interface DetachedAssumptions extends HousingCommonAssumptions {
  housingType: "detached";
  typeSpecific?: {
    landCostYen?: MoneyYen;
    buildCostYen?: MoneyYen;
  };
  repairsSchedule?: RepairsScheduleItem[];
}

export interface CondoAssumptions extends HousingCommonAssumptions {
  housingType: "condo";
  typeSpecific?: {
    managementFeeMonthlyYen?: MoneyYen;
    repairReserveMonthlyYen?: MoneyYen;
  };
}

export interface RentAssumptions extends HousingCommonAssumptions {
  housingType: "rent";
  typeSpecific?: {
    rentMonthlyYen?: MoneyYen;
    renewalFeeYen?: MoneyYen;
    depositYen?: MoneyYen;
    keyMoneyYen?: MoneyYen;
  };
}

export type HousingAssumptions =
  | HighPerformanceHomeAssumptions
  | DetachedAssumptions
  | CondoAssumptions
  | RentAssumptions;
```

---

## Dependencies

- なし（先行して定義する）

## Follow-ups（関連チケット）

- B2. IndexedDB スキーマ設計
- B4. Repository インターフェース定義
- B5. IndexedDB Repository 実装
- J1. Zod によるドメインバリデーション導入

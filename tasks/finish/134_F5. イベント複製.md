# Jira チケット（F5）イベント複製（Duplicate）

## Summary

F5. イベント複製（Duplicate）— 既存イベントをコピーして新規イベントとして作成する

## Issue Type

Story（または Task）

## Priority

Medium（ただし入力効率を上げたい場合は High）

## Background / Context

イベント登録では類似イベント（学費、保険料、複数の教育費など）を繰り返し作るケースが多い。  
複製機能により、入力の手間を削減し、継続入力を促進する。

MVP 永続化は IndexedDB のため、B5 の EventRepository を用いて複製を実装する。

## Goal

- イベント一覧/編集画面から「複製」を実行できる
- 複製により、新しいイベントレコードが作成される（id/createdAt/updatedAt が新規）
- 複製後に編集画面へ遷移し、すぐに微修正できる
- 失敗時に安全に通知される（toast）

---

## In Scope

- 複製アクションの UI 接続
  - イベント一覧（F1）の行メニューに「複製」
- Repo 連携（いずれか）
  - `EventRepo.duplicate(eventId)` を呼ぶ
  - もしくは `EventRepo.get(eventId)` → `EventRepo.create(copyPayload)` で実装
- 複製後の遷移
  - 推奨：`/plans/[planId]/events/[newEventId]/edit`
  - 代替：`/plans/[planId]/events` に戻して一覧で確認
- toast（成功/失敗）

## Out of Scope

- 複製時の高度な調整（開始月を自動で次月にずらす等）
- 一括複製（複数選択）
- バージョン跨ぎの複製（別 Version へコピー）

---

## Functional Requirements

### 1) 複製対象

- 対象：指定 `eventId` のイベント
- 複製先：同一 `planVersionId`（イベントは Version 配下の前提データのため）

### 2) 複製データのルール

- 引き継ぐ項目：
  - planVersionId
  - title
  - eventType
  - startYm
  - cadence
  - durationMonths
  - amountYen
  - direction
  - note
- 変更する項目：
  - id：新規発行
  - createdAt：新規
  - updatedAt：新規
  - title：`{元タイトル}（コピー）` を付与
- cadence=once の場合は durationMonths は 1 固定（元が once の場合も 1 を維持）

### 3) UI フロー

- イベント一覧で「複製」クリック
  - ローディング（任意）
  - 成功 → toast `イベントを複製しました`
  - 遷移 → 新イベントの編集画面（推奨）
- 失敗 → toast `複製に失敗しました`（入力は不要）

### 4) エラーケース

- eventId が存在しない（get が undefined）
  - toast：`イベントが見つかりません`
  - 画面は現状維持
- Repo 操作失敗
  - toast：`複製に失敗しました`

---

## UI Requirements

- 一覧（F1）の行メニュー（DropdownMenu）に「複製」（Copy アイコン）
- クリック可能領域が小さすぎない（モバイル対応）
- 複製実行中は二重実行できないようにする（任意）

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo（推奨実装）：
  - `duplicate(eventId): Promise<LifeEvent>` を Repo に実装して使う
- もし Repo に duplicate が無い場合の実装案：
  - `src/lib/usecases/duplicateLifeEvent.ts`
    - `const src = await EventRepo.get(eventId)`
    - `await EventRepo.create({ ...src, id/createdAt/updatedAt除外, title付与 })`
- 複製後の遷移：
  - Next.js `useRouter().push(...)`

---

## Acceptance Criteria

- [ ] イベント一覧のメニューから「複製」を実行できる
- [ ] 複製により新しいイベントが作成され、一覧に増える
- [ ] 複製後に新イベントの編集画面へ遷移できる
- [ ] 新イベントは id/createdAt/updatedAt が新規である
- [ ] タイトルに（コピー）が付与される
- [ ] 不正 eventId/失敗時に toast で通知される
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載（複製 → 編集 → 一覧反映、存在しない ID）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（EventRepo 実装）
- F1（一覧 UI に複製導線を付ける場合）
- F4（複製後に編集へ遷移する場合はあると確認しやすい）

## Follow-ups（関連チケット）

- F6. イベント削除
- （将来）複製時に startYm を次月にずらすオプション

# Jira チケット（D6）ダッシュボード：直近イベント表示（次の 3 件）

## Summary

D6. ダッシュボード：直近イベント表示（次の 3 件）— 今後イベントを最大 3 件表示して導線を作る

## Issue Type

Story（または Task）

## Priority

Medium（ダッシュボードの価値を上げるが、入力導線は D1/D2/D8 が先）

## Background / Context

イベント（ライフイベント）は将来見通しや支出計画の核になる。  
ダッシュボードに「直近のイベント」を表示することで、入力の動機付けと見直し導線を強化できる。

MVP 永続化は IndexedDB のため、B5 の VersionRepo / EventRepo を利用して取得・表示する。

## Goal

- ダッシュボードに「今後の直近イベント（最大 3 件）」を表示できる
- イベントが無い場合は空状態を表示し「追加」へ誘導できる
- 各イベントから編集へ遷移できる
- “イベント一覧へ” 導線がある

---

## In Scope

- 画面：`/plans/[planId]`（ダッシュボード）
- Repo 連携：
  - `VersionRepo.getCurrent(planId)` → planVersionId 取得
  - `EventRepo.listByVersion(planVersionId, { scope: "all" or "upcoming" })`
- 抽出ロジック：
  - 今後イベント（startYm >= currentYm）
  - startYm 昇順で最大 3 件
- 表示コンポーネント（カード/リスト）実装
- 導線：
  - イベント一覧へ（/events）
  - イベント追加へ（/events/new）
  - イベント編集へ（/events/[eventId]/edit）
- ローディング/エラー表示（最小）

## Out of Scope

- イベント作成/編集自体（F3/F4）
- 将来見通しへの反映（I2）
- 表示の高度化（カテゴリ別集計、カレンダー表示）

---

## Functional Requirements

### 1) データ取得

- 画面初期化時に以下を取得（D1/D2 と並列化して OK）
  1. `currentVersion = VersionRepo.getCurrent(planId)`
  2. `events = EventRepo.listByVersion(currentVersion.id, { scope: "all" })`（MVP 推奨）
- currentVersion が取得できない場合：
  - 表示：`現行バージョンがありません`
  - CTA：`改定を作成` → `/plans/[planId]/versions/new`（将来でも OK）

### 2) 直近（今後）イベント抽出

- `currentYm`（"YYYY-MM"）を取得（A5 推奨）
- 抽出条件：
  - `event.startYm >= currentYm`
- 並び順：
  - `event.startYm asc`
- 表示件数：
  - `nextEvents = filtered.slice(0, 3)`

### 3) 表示（MVP 最小）

各行に以下を表示：

- 発生月：`YYYY年M月`（formatYearMonth）
- タイトル：`event.title`（無ければ eventType）
- バッジ：`単発/毎月`、`支出/収入`（任意：種別も）
- 金額：`amountYen`（formatYen）
  - 支出はマイナス表現にしない（色やラベルで支出/収入を表現）
- 毎月の場合：
  - `◯円/月` 表示
  - `durationMonths` を `（◯ヶ月）` で表示

### 4) 導線

- ヘッダー右：
  - `イベント一覧` → `/plans/[planId]/events`
- 空状態時：
  - `イベントがまだありません` または `今後のイベントがありません`
  - CTA：`イベントを追加` → `/plans/[planId]/events/new`
- 行クリック or ボタン：
  - `編集` → `/plans/[planId]/events/[eventId]/edit`

### 5) ローディング/エラー

- ローディング：Skeleton or `読み込み中...`
- エラー：toast or Alert `イベントの取得に失敗しました`
  - エラーでもダッシュボード他要素は表示（イベント枠だけ失敗）

---

## UI Requirements

- v0 モック準拠（カード内にリスト 3 行）
- 3 件を超える場合は `もっと見る`（イベント一覧）導線を表示
- モバイルでは 2 行表示＋詳細は編集画面へ

---

## Technical Notes

- `"use client"`（IndexedDB）
- util（A5）：
  - `getCurrentYearMonth()`
  - `formatYearMonth(ym)`
  - `formatYen(amount)`
- Repo：
  - `VersionRepo.getCurrent(planId)`
  - `EventRepo.listByVersion(planVersionId, ...)`
- MVP は全件取得 →filter/sort/slice で OK（イベント数が小さい前提）

---

## Acceptance Criteria

- [ ] ダッシュボードに今後イベントが最大 3 件表示される
- [ ] startYm が近い順に並ぶ
- [ ] イベントが無い場合、空状態と「追加」CTA が表示される
- [ ] 「イベント一覧」へ遷移できる
- [ ] 各イベントから編集画面へ遷移できる
- [ ] ローディング/エラー時の表示がある
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 今後イベント 0 件/1 件/3 件/4 件以上
  - 過去イベントのみ（今後 0 件）
  - 編集遷移
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（VersionRepo / EventRepo）
- F1/F3（イベントが作れると確認が容易）
- （推奨）A5（フォーマット util）
- D1（ダッシュボード基盤）

## Follow-ups（関連チケット）

- D4（次にやること：イベント追加の促しを連動）
- I2（将来推移にイベント反映）

---

## Decisions

- Upcoming-only display: filter by startYm >= currentYm (no fallback to past).
- Event card handles missing current version or event fetch errors; other dashboard sections keep rendering.
- "More" link shows only when upcoming events are 4+.
- Empty state text for 0 events or no upcoming events; CTA goes to add event.
- When title is empty, fall back to the same event type label as the events list.

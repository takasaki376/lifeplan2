# Jira チケット（E2）月次一覧：当月ハイライト・行アクション（入力/編集/詳細/複製/削除）

## Summary

E2. 月次一覧：当月ハイライト・行アクション（入力/編集/詳細/複製/削除）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

E1 で「年選択・状態フィルタ＋ IndexedDB 連携」により、月次一覧の基礎表示は成立している前提。  
E2 では、月次一覧を“日常的に使える”状態にするために、当月の視認性向上と行アクション（入力/編集/詳細/複製/削除）を実装する。

## Goal

- 当月が一目で分かる（ハイライト）
- 各月に対して、最短で入力・編集・詳細・複製・削除ができる
- 複製・削除は安全（confirm/toast）で、データ整合性が保たれる（records/items）

---

## In Scope

- 当月ハイライトの強化（E1 のハイライトを“確定仕様”にする）
- 行アクションの実装：
  - 入力（未入力月）
  - 編集（入力済み月）
  - 詳細（常に表示）
  - 複製（前月コピー or 指定月コピー）
  - 削除（確認ダイアログ）
- 右端アクションの UI（ボタン + kebab menu）※v0 モックに準拠
- IndexedDB 連携（Repo 呼び出し）：
  - MonthlyRepository
  - MonthlyItem（詳細内訳）削除/置換が必要な場合

## Out of Scope

- 収支自動計算の高度化（E5）
- 詳細内訳入力 UI（E6〜）
- CSV/エクスポート（将来）
- 複製時の高度なマージ（基本は単純コピー）

---

## Functional Requirements

### 1) 当月ハイライト（仕様確定）

- `currentYm` が表示年に含まれる場合、その行を強調表示
  - 背景色（muted）
  - 左ボーダー（accent）
  - “今月”バッジ（任意）
- 当月行の主要アクションを優先表示
  - 未入力：`入力する`（primary）
  - 入力済み：`編集`（secondary） + `詳細`（ghost）

### 2) 行アクション：入力/編集/詳細

- 未入力月：
  - primary ボタン：`入力する` → `/plans/[planId]/months/[yyyy-mm]`
- 入力済み月：
  - ボタン：`編集` → `/plans/[planId]/months/[yyyy-mm]`
- 全ての月：
  - ボタン：`詳細` → `/plans/[planId]/months/[yyyy-mm]/detail`

### 3) 行アクション：複製（コピー）

MVP の複製要件を以下に定義（どちらか採用。採用方針をチケット内で確定して実装）：

#### 方針 A（推奨・最短）：前月コピー

- アクション名：`前月をコピー`
- 挙動：
  - 対象月 `ym` の前月 `prevYm` を探し、
  - `MonthlyRepository.copyFromPreviousMonth(planId, ym)` を呼ぶ
  - 成功時：toast `前月の値をコピーしました`
  - 前月データ無し：toast `前月のデータがありません`（何もしない）

#### 方針 B（発展）：任意月からコピー

- アクション名：`この月を複製`
- 挙動：
  - 「コピー元月」を選ぶダイアログ（Select）を表示（MVP では省略可）
  - コピー元の 4 ボックス＋（任意で）内訳をコピーする

※MVP は方針 A で十分。UI メニューには「前月コピー」として実装するのが無難。

### 4) 行アクション：削除（確認）

- アクション名：`削除`
- 削除前に confirm dialog を必須
  - Title：`この月のデータを削除しますか？`
  - Description：`この操作は取り消せません。`
  - Buttons：Cancel / Delete（destructive）
- 削除対象：
  - `monthlyRecords`（planId+ym）
  - 紐づく `monthlyItems`（monthlyRecordId）も削除（存在する場合）
- Repo 呼び出し：
  - `MonthlyRepository.deleteByYm(planId, ym)`（内部で items も削除する実装が望ましい）
- 成功時：toast `削除しました`
- 失敗時：toast `削除に失敗しました`

### 5) 表示と操作の整合

- 削除/複製後はリストを即時更新
  - re-fetch（listByPlan） or state 更新（Map を更新）
- フィルタ状態（未入力/入力済み）に応じて、行の出入りが正しく反映される
  - 例：削除 → 未入力へ移動

---

## UI Requirements

- 行の右端に actions を配置（Desktop）
- Mobile はボタンを減らし、kebab menu（DropdownMenu）にまとめる
- “複製/削除” はメニュー内に配置し、誤操作を防ぐ
- ローディング中は actions を disabled（任意）

---

## Technical Notes

- `"use client"`（IndexedDB）
- util（A5）：
  - `formatYearMonth(ym)` / `formatYen(...)`
  - `prevYearMonth(ym)`（ない場合は実装 or ローカルで計算）
- Repo：
  - `MonthlyRepository.getByYm` / `listByPlan`
  - `MonthlyRepository.copyFromPreviousMonth`（E4 が先なら E4 に寄せても OK）
  - `MonthlyRepository.deleteByYm`
- 削除は必ず record/items を一括で消す（Repo 内 tx 推奨）

---

## Acceptance Criteria

- [ ] 当月行が視覚的に強調され、“今月”が一目で分かる
- [ ] 未入力月に `入力する` が表示され、押すと該当月のかんたん入力へ遷移できる
- [ ] 入力済み月に `編集` が表示され、押すと該当月のかんたん入力へ遷移できる
- [ ] 全ての月で `詳細` に遷移できる
- [ ] `前月をコピー`（複製）が動作し、成功/失敗の toast が出る
- [ ] `削除` が confirm 付きで動作し、record/items が削除される
- [ ] 複製/削除後に一覧が即時更新され、フィルタ結果も正しく反映される

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載
  - 当月ハイライト確認
  - 未入力 → 入力導線
  - 入力済み → 編集導線
  - 前月コピー（前月あり/なし）
  - 削除（confirm/反映）
- [ ] lint/typecheck が通る

---

## Dependencies

- E1（月次一覧の基礎）
- B5（MonthlyRepository の実装）
- （推奨）E4（copyFromPreviousMonth を独立チケットで先に実装する場合）

## Follow-ups（関連チケット）

- E4. 前月コピー機能（copyFromPreviousMonth の本実装を分離する場合）
- E10. 月次削除（より詳細な仕様・関連データ整理が必要なら分離）

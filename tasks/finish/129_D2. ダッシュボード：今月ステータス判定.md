# Jira チケット（D2）ダッシュボード：今月ステータス判定（未入力/入力済み）

## Summary

D2. ダッシュボード：今月ステータス判定（未入力/入力済み）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

D1 でダッシュボードの基本情報（plan/currentVersion）表示ができている前提。  
次に、継続管理の中心導線として「今月の入力状況（未入力/入力済み）」を判定し、  
ダッシュボード上の CTA（今月を入力/編集）やバッジ表示に反映する。

MVP 永続化は IndexedDB のため、B5 の `MonthlyRepository` を利用して判定する。

## Goal

- ダッシュボードで「今月：未入力/入力済み」を正しく表示できる
- 状態に応じて主ボタン（入力する/編集する）を切り替えられる
- 最終更新日時（入力済みの場合）を表示できる（任意だが推奨）

---

## In Scope

- 画面：`/plans/[planId]`（ダッシュボード）
- 今月（currentYm）の決定（"YYYY-MM"）
- `MonthlyRepository.getByYm(planId, currentYm)` による存在判定
- UI 反映：
  - ステータスバッジ（未入力/入力済み）
  - 主 CTA の切替（入力する/編集する）
  - 最終更新（updatedAt）表示（入力済みの場合）
- ローディング/エラー時の表示（最小）

## Out of Scope

- 今月の収支・残高カード（D3）
- 次にやることチェックリスト（D4）
- 月次一覧側の当月ハイライト（E1/E2）
- 前月コピー（E4）
- 詳細内訳の整合（E8/E9）

---

## Functional Requirements

### 1) 今月キー（currentYm）の生成

- 形式：`"YYYY-MM"`（例：`2026-01`）
- 共通 util（A5）を利用する（推奨）
  - `getCurrentYearMonth()` など

### 2) 判定ロジック

- `record = MonthlyRepo.getByYm(planId, currentYm)`
- 判定：
  - `record` が存在しない → **未入力**
  - `record` が存在する → **入力済み**
- 表示（入力済み時）：
  - `最終更新: YYYY/MM/DD`（record.updatedAt）
- 追加の扱い（任意・MVP では簡易で OK）：
  - 4 ボックスが全て undefined でも「存在すれば入力済み」扱いで OK
  - “確定”概念（isFinalized）がある場合でも、D2 は存在判定のみで OK（深掘りは後続）

### 3) UI 反映（ダッシュボード内）

- ステータスバッジ：
  - 未入力：`未入力`（destructive）
  - 入力済み：`入力済み`（success）
- 主 CTA：
  - 未入力：`今月を入力` → `/plans/[planId]/months/current`
  - 入力済み：`今月を編集` → `/plans/[planId]/months/current`
- サブ導線（任意）：
  - `月次一覧へ` → `/plans/[planId]/months`

### 4) ローディング/エラー

- 月次取得中：バッジを Skeleton、CTA を disabled（任意）
- 失敗時：toast or small alert
  - “今月ステータスの取得に失敗しました”
  - CTA は表示しても良い（入力導線を塞がない）

---

## Technical Notes

- `"use client"`（IndexedDB）
- D1 と同様に、ダッシュボードの `useEffect` で取得
- 可能なら `Promise.all` で D1（plan/currentVersion）と並列取得
- util（A5）：
  - `getCurrentYearMonth()`
  - `formatYearMonth(currentYm)`（表示に使うなら）
  - 日付表示は `formatDate(iso)` を追加しても良い（A5 拡張 or ローカル実装）

---

## Acceptance Criteria

- [ ] ダッシュボードで「未入力/入力済み」バッジが正しく切り替わる
- [ ] 未入力の場合、主 CTA が `今月を入力` になり、押すと月次かんたん入力へ遷移できる
- [ ] 入力済みの場合、主 CTA が `今月を編集` になり、押すと同じく月次かんたん入力へ遷移できる
- [ ] 入力済みの場合、最終更新日時が表示される（任意だが推奨）
- [ ] 取得失敗時にユーザーに分かる通知がある（toast/alert）
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 今月 record 無し → 未入力表示
  - 今月 record 作成後 → 入力済み表示
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（MonthlyRepository 実装）
- （推奨）A5（currentYm 生成・フォーマット util）
- D1（ダッシュボードの基盤表示があること）

## Follow-ups（関連チケット）

- D3. 今月の収支・残高カード（record の数値表示）
- D8. 空状態（初回）分岐（今月未入力を起点にオンボーディング）
- E3. 月次かんたん入力：保存（upsert）

# Jira チケット（B5）IndexedDB Repository 実装（全 Repo）

## Summary

B5. IndexedDB Repository 実装（全 Repo：PlanRepo / VersionRepo / MonthlyRepo / EventRepo / HousingRepo）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

B4 で定義した Repository インターフェースを、MVP 永続化（IndexedDB）で動かすための実装を行う。  
B3 の IndexedDB ラッパー（CRUD/tx/index 操作）を利用し、UI からは Repository 経由で読み書きできる状態にする。

- B1：ドメイン型
- B2：IndexedDB スキーマ（objectStore/index）
- B3：IndexedDB ラッパー
- B4：Repository インターフェース
- B5：IndexedDB Repository 実装（本チケット）

## Goal

- 主要画面（プラン/ダッシュボード/月次/イベント/住宅 LCC/改定）の CRUD を Repository で提供する
- 複数 store 更新が必要な処理（tx）を安全に実装する
- isCurrent/isSelected の整合（1 つだけ true）をトランザクションで担保する
- “将来 Supabase 実装”が同じインターフェースで差し替え可能である状態を作る

---

## In Scope

- `IndexedDbPlanRepository`
- `IndexedDbVersionRepository`
- `IndexedDbMonthlyRepository`
- `IndexedDbEventRepository`
- `IndexedDbHousingRepository`
- （方針により）`IndexedDbScenarioAssumptionsRepository` または VersionRepo 内メソッド実装
- 参照パターンに合う index 利用（B2 準拠）
- tx 必須ユースケースの実装
  - 月次削除（record + items）
  - 月次詳細保存（items 置換）
  - currentVersion 切替（旧 current を false、新 current を true）
  - selectedHousing 切替（旧 selected を false、新 selected を true）
  - plan 削除（関連データ一括削除：versions, assumptions, events, housing, monthly, items）

## Out of Scope

- UI 画面への結線（C/D/E/F/G/H 側で実施）
- Zod バリデーション（J1）
- Supabase 実装（B6）
- LCC/将来推移の計算ロジック（G9/I2）

---

## Deliverables

- `src/lib/repo/indexeddb/` 配下に Repo 実装を追加（例）
  - `planRepo.ts`
  - `versionRepo.ts`
  - `monthlyRepo.ts`
  - `eventRepo.ts`
  - `housingRepo.ts`
  - `index.ts`（export まとめ）
- B4 の interface を実装したクラス/関数を提供
- 簡易動作確認手順（docs または PR 本文）
  - 「プラン作成 → 月次保存 → イベント保存 → 住宅前提保存 → 改定作成」まで DB に残ること

---

## Implementation Requirements（Repo 別）

### 1) PlanRepo（IndexedDB）

- list（検索・status フィルタ・updatedAt 降順）
- get（planId）
- create（plan 作成：id 生成、timestamps 付与）
- update
- archive / restore
- delete（関連データ削除は tx で一括）
- setCurrentVersion（plan に pointer を持つ場合のみ）

**Indexes used**

- `plans.by_userId_status` / `plans.by_updatedAt`（設計に合わせる）

**Tx required**

- plan 削除：`plans` + `planVersions` + `scenarioAssumptions` + `lifeEvents` + `housingAssumptions` + `monthlyRecords` + `monthlyItems`

---

### 2) VersionRepo（IndexedDB）

- listByPlan（versionNo 降順）
- get(versionId)
- getCurrent(planId)（by_planId_isCurrent）
- createFromCurrent(planId, changeNote?)
  - 現行 version を複製して新 version を作成
  - 付随データも複製：
    - scenarioAssumptions（3 件）
    - lifeEvents
    - housingAssumptions（4 件）
- setCurrent(planId, versionId)
  - planId 内の旧 current を false、新を true（tx で一貫性）
- delete(versionId)（現行は削除不可 or 例外）

**Indexes used**

- `planVersions.by_planId_versionNo`
- `planVersions.by_planId_isCurrent`

**Tx required**

- setCurrent（旧 current 解除 + 新 current 設定）
- createFromCurrent（version + related assumptions/events/housing の複製）

---

### 3) MonthlyRepo（IndexedDB）

- getByYm(planId, ym)（unique index by_planId_ym）
- listByPlan(planId, {year?, sort?})（index cursor）
- upsert(record)
- upsertByYm(planId, ym, patch)
- copyFromPreviousMonth(planId, ym)
  - 前月の `monthlyRecords` を取得して当月へコピー（存在しない場合の挙動を規定：空の record 生成 or throw）
- deleteByYm(planId, ym)
  - record 削除 + items 削除（tx）

#### MonthlyItem（詳細内訳）

- listItems(monthlyRecordId)
- replaceItems(monthlyRecordId, items)
  - 既存 items 削除 → 新 items 一括 put（tx）
- deleteItemsByRecord(monthlyRecordId)

**Indexes used**

- `monthlyRecords.by_planId_ym`
- `monthlyItems.by_monthlyRecordId`

**Tx required**

- deleteByYm（records+items）
- replaceItems（items 置換）

---

### 4) EventRepo（IndexedDB）

- listByVersion(planVersionId, filters)
  - upcoming/past/all は `startYm` と「現在 ym」を比較（アプリ側フィルタでも OK だが、可能なら index cursor で絞る）
- get(eventId)
- create/update
- duplicate
- delete

**Indexes used**

- `lifeEvents.by_versionId_startYm`

---

### 5) HousingRepo（IndexedDB）

- listByVersion(planVersionId)（4 件）
- getByType(planVersionId, housingType)（unique by_versionId_type）
- upsert(assumptions)
- setSelected(planVersionId, housingType)
  - 同 version 内の旧 selected 解除 + 新 selected 設定（tx）
- applyPreset(planVersionId, housingType, preset)（任意：MVP で便利）
  - かんたん前提を preset で上書き

**Indexes used**

- `housingAssumptions.by_versionId_type`
- `housingAssumptions.by_versionId_isSelected`（任意）

**Tx required**

- setSelected（selected 整合）

---

## Cross-cutting Requirements

- ID 生成（uuid）は Repo 側で行うか、呼び出し側で注入するかを統一
  - 推奨：Repo 内部で `crypto.randomUUID()`（ブラウザ）※SSR 回避
- timestamps（createdAt/updatedAt）は Repo で付与
- 並び順：
  - plans：updatedAt desc
  - versions：versionNo desc
  - monthly：ym desc
  - events：startYm asc（今後）
- 例外は基本 throw（UI で toast 表示できるように）

---

## Acceptance Criteria

- [ ] B4 で定義した全 Repo interface を IndexedDB 実装で満たしている
- [ ] 主要 CRUD が動く（plan/月次/event/housing/version）
- [ ] unique キー要件を満たす（planId+ym、versionId+housingType 等）
- [ ] tx が必要な処理が tx で実装されている（削除・置換・current/selected 切替）
- [ ] createFromCurrent が related data を複製できる（scenario/events/housing）
- [ ] typecheck が通り、export が整っている（`repo/indexeddb/index.ts` など）

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 最低限の手動検証手順が PR に記載（例：DevTools で DB 確認できる）
- [ ] 代表的なユースケースが動くことを確認
  - プラン作成 → 月次保存 → イベント追加 → 住宅前提変更 → 新バージョン作成 → 現行切替

---

## Dependencies

- B1（型）
- B2（スキーマ）
- B3（IndexedDB ラッパー）
- B4（Repo interface）

## Follow-ups（関連チケット）

- C1/C2/E3/F3/G5/H3：各画面から Repo を呼ぶ結線
- K2/K3：エクスポート/インポート（将来移行・デバッグに有効）
- B6：Supabase Repo スタブ

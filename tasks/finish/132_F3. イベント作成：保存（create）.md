# Jira チケット（F3）イベント作成：保存（create）

## Summary

F3. イベント作成：保存（create）— IndexedDB（Repository）へ永続化して一覧へ戻す

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

v0 でイベント作成画面 UI は作成済み。F2 で入力バリデーションを実装済みの前提で、
作成画面からイベントを保存（create）し、イベント一覧に反映される状態を作る。

MVP では永続化が IndexedDB のため、B5 の `EventRepository` を使用する。

## Goal

- `/plans/[planId]/events/new` で入力したイベントを保存できる
- 保存後に `/plans/[planId]/events` に戻り、新規イベントが一覧に表示される
- 保存中の状態・成功/失敗のフィードバック（disabled/toast）を実装する
- 現行 Version（planVersionId）に紐づけて保存される

---

## In Scope

- イベント作成画面（/plans/[planId]/events/new）の保存処理
- Repo 連携：
  - `VersionRepo.getCurrent(planId)`（planVersionId 取得）
  - `EventRepo.create(...)`
- F2 バリデーションの適用（保存前に validate）
- 保存中 UI（ボタン disabled、スピナー等）
- 保存結果の通知（toast）
- 保存後遷移：イベント一覧へ

## Out of Scope

- 編集画面の更新（F4）
- 複製（F5）
- 削除（F6）
- 将来見通しへの反映（I2）
- 高度なスケジューリング（インフレ連動等）

---

## Functional Requirements

### 1) 現行 Version の解決

- 画面表示時または保存時に currentVersion を取得
  - `currentVersion = VersionRepo.getCurrent(planId)`
- currentVersion が取得できない場合：
  - 保存をブロック
  - Alert/Toast：`現行バージョンが見つかりません`
  - CTA：`改定を作成` → `/plans/[planId]/versions/new`（将来でも OK）

### 2) 保存前バリデーション（F2）

- 保存ボタン押下時に `validateLifeEventDraft(draft)` を実行
- invalid の場合：
  - フィールドエラー表示
  - 保存処理を呼ばない

### 3) create payload の組み立て

- `planVersionId` は currentVersion.id を使用
- 送信データ（最小）：
  - title（必須）
  - eventType（選択、未選択なら "other"）
  - startYm（必須：YYYY-MM）
  - cadence（once/monthly）
  - amountYen（>0）
  - direction（expense/income）
  - durationMonths（once は 1 固定、monthly は必須）
  - note（任意）
- createdAt/updatedAt/id は Repo 側で付与（推奨）

### 4) 保存処理

- `await EventRepo.create(payload)`
- 成功時：
  - toast：`イベントを保存しました`
  - `router.push(/plans/[planId]/events)`
- 失敗時：
  - toast：`保存に失敗しました`
  - 画面に留まる（入力は保持）

### 5) 保存中の UX

- 保存中は保存ボタンを disabled
- 二重送信防止（loading フラグ）
- 可能ならキャンセルボタンも disabled（任意）

---

## UI Requirements

- v0 モックに準拠
- ヘッダー右上：
  - `キャンセル` → `/plans/[planId]/events`
  - `保存`（primary）
- 保存中：
  - `保存中...` 表示またはスピナー
- 画面右側プレビュー（あれば）：
  - 入力内容を反映（保存とは独立）

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo 依存：
  - `VersionRepository.getCurrent(planId)`
  - `EventRepository.create(payload)`
- ルーティング：
  - Next.js `useRouter()` で push
- date/ym util（A5 推奨）：
  - `toYearMonth(date)` / `getCurrentYearMonth()`（初期値）
- amount 入力は `type="number"` 前提（カンマ除去は不要）

---

## Acceptance Criteria

- [ ] イベント作成画面で必須項目を入力し、保存すると IndexedDB に作成される
- [ ] 保存後にイベント一覧へ遷移し、新規イベントが表示される
- [ ] バリデーションエラー時は保存されず、エラーが表示される（F2 連携）
- [ ] 保存中は二重送信できない（ボタン disabled）
- [ ] 保存失敗時に toast が出て入力が保持される
- [ ] currentVersion が無い場合に保存できず、適切な案内が出る
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 正常保存 → 一覧反映
  - バリデーション NG→ 保存されない
  - 保存失敗（例：Repo を一時 throw）→toast & 入力保持
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（EventRepo / VersionRepo 実装）
- F2（入力バリデーション）
- （推奨）A5（通貨/年月ユーティリティ）

## Follow-ups（関連チケット）

- F4. イベント編集：更新（update）
- F5. イベント複製
- F6. イベント削除

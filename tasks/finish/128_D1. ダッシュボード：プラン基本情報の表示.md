# Jira チケット（D8）ダッシュボード：空状態（初回）分岐

## Summary

D8. ダッシュボード：空状態（初回）分岐（初回ユーザー/初回プランの導線整備）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

v0 でダッシュボード UI モックは作成済み。MVP は IndexedDB 永続化のため、プラン作成直後や月次未入力、住宅前提未設定、イベント未登録など「データが揃っていない状態」が頻出する。  
初回で“空のカードが並ぶだけ”になると離脱しやすいため、データ状態に応じた空状態表示と最短 CTA を整備する。

## Goal

- データ欠損時でもダッシュボードが破綻せず、次にやることが明確になる
- 初回でも「月次入力 → 住宅前提 → イベント追加」の最短導線を提示できる
- 状態に応じた分岐（空状態）を統一し、今後の拡張に耐える

---

## In Scope

- ダッシュボード `/plans/[planId]` の空状態分岐ロジック実装
- Repository 取得結果に応じた UI 切替（Onboarding/Callout/Checklist）
- 空状態カード（初回向け）＋ CTA 実装
- “次にやること”チェックリスト（最大 3〜5）を状態に応じて生成

## Out of Scope

- LCC 計算精度向上（G9）
- 将来見通しの本格実装（I 系）
- バージョン差分の高度化（H 系）
- KPI 集計の拡充（D3/D5/D6 は別チケット）

---

## Data Dependencies（参照データ）

- Plan：`PlanRepo.get(planId)`
- Current Version：`VersionRepo.getCurrent(planId)`
- 当月 MonthlyRecord：`MonthlyRepo.getByYm(planId, currentYm)`
- 住宅前提：`HousingRepo.listByVersion(planVersionId)`（4 タイプ揃っているか / selected 有無）
- イベント：`EventRepo.listByVersion(planVersionId, { scope: "upcoming" })`（0 件判定、直近表示は D6）

---

## Empty State Definitions（状態定義：優先度順）

### State 0：Plan が存在しない/取得失敗

- 表示：Not Found or Error
- CTA：`プラン一覧へ戻る`

### State 1：初回（当月 MonthlyRecord が存在しない）

- 表示：Onboarding Card（大きめ）
  - Title：`まずは今月の合計を入力しましょう`
  - Text：`正確でなくてOK。あとから修正できます。`
- CTA（Primary）：`今月を入力` → `/plans/[planId]/months/current`
- CTA（Secondary）：`月次一覧を見る` → `/plans/[planId]/months`

### State 2：住宅前提が未設定/不足（housingAssumptions が 0 件 or 4 タイプ不足）

- 表示：Callout
  - `住宅LCC比較を使うには前提の設定が必要です`
- CTA：`住宅前提を設定` → `/plans/[planId]/housing/assumptions`
- Secondary：`比較トップへ` → `/plans/[planId]/housing`

### State 3：住宅タイプ未選択（4 件あるが isSelected が無い）

- 表示：Callout
  - `比較する住宅タイプを選択しましょう`
- CTA：`住宅LCC比較へ` → `/plans/[planId]/housing`

### State 4：イベントが 0 件

- 表示：提案カード
  - `イベントを追加すると見通しが良くなります`
- CTA：`イベントを追加` → `/plans/[planId]/events/new`
- Secondary：`イベント一覧` → `/plans/[planId]/events`

### State 5：通常状態（READY）

- 通常のダッシュボード表示（v0 モックに準拠）
- “次にやること”は未完がある場合のみ表示

---

## UI Requirements

- 上部に「初回オンボーディングカード」を差し込める領域
- “次にやること”チェックリスト（最大 3〜5）
  - 今月を入力
  - 住宅前提を設定
  - 住宅タイプを選択
  - イベントを追加
- 各項目にステータス（未完/完了）と CTA ボタン
- ローディング：Skeleton or `読み込み中...`
- エラー：Alert + `プラン一覧へ戻る`

---

## Technical Notes

- `"use client"`（IndexedDB）
- `currentYm` は共通 util（A5）で生成（"YYYY-MM"）
- 取得は `Promise.all` で並列（必要最小限）
- EventRepo に limit が無ければ全件 → ソート →slice で MVP 対応可
- 状態管理例：
  - `isLoading`, `error`
  - `dashboardState`：`NOT_FOUND | FIRST_TIME | NEEDS_HOUSING | NEEDS_SELECTION | NEEDS_EVENTS | READY`

---

## Acceptance Criteria

- [ ] Plan が取得できない場合に安全にフォールバック（NotFound/戻る導線）
- [ ] 当月未入力でオンボーディングカード＋`今月を入力`導線が出る
- [ ] 住宅前提が未設定/不足で `前提を設定` CTA が出る
- [ ] 住宅タイプ未選択で `比較へ` CTA が出る
- [ ] イベント 0 件で `イベント追加` CTA が出る
- [ ] 通常状態で通常表示に戻る
- [ ] ローディング/エラー表示がある
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載（初回/住宅未設定/イベントなし/通常）
- [ ] lint/typecheck が通る

## Dependencies

- B5（各 Repo：Plan/Version/Monthly/Housing/Event）
- A5（currentYm 生成・フォーマット util）※推奨
- D1/D2（ベース表示・今月判定があると組み込みやすい）

## Follow-ups

- D4（次にやること拡充）
- D5/D6（住宅 LCC/イベントのサマリーカード）

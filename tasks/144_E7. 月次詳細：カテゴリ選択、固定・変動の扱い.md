# Jira チケット（E7）月次詳細：カテゴリ選択・固定/変動の扱い（MVP 仕様）

## Summary

E7. 月次詳細：カテゴリ選択・固定/変動の扱い（MVP 仕様に合わせて）

## Issue Type

Story（または Task）

## Priority

Medium-High（E6 の価値を上げ、家計の構造化を可能にする）

## Background / Context

Knowledge 上、月次データでは「支出（固定/変動）」の区分がコア要素。:contentReference[oaicite:1]{index=1}
E6 で内訳行 CRUD ができた前提で、E7 では内訳行に「カテゴリ」と「固定/変動（主に支出）」を付与できるようにし、
後続の集計（固定費合計/変動費合計、カテゴリ別集計）に繋がる土台を作る。

## Goal

- 月次詳細の内訳行にカテゴリを設定でき、保存・復元できる
- 支出内訳に固定/変動を設定でき、保存・復元できる
- デフォルト値（カテゴリ → 固定/変動の推定）で入力負担を減らす
- UI 上で固定費/変動費の小計表示（表示のみ）まで実装する（集計ロジックは軽量）

---

## In Scope

- `MonthlyItem` に以下フィールド追加（型/保存/復元）
  - `category?: string`
  - `expenseNature?: "fixed" | "variable"`（支出のみ）
- 月次詳細 UI（E6）に以下を追加
  - カテゴリ Select（収入/支出）
  - 支出行に固定/変動トグル（Segment/Tabs/Select）
  - 固定費合計/変動費合計の表示（支出のみ、UI 内集計）
- デフォルト推定
  - カテゴリ選択時に `expenseNature` を自動セット（ユーザーは手動で上書き可能）
- 保存（E6 の replace 保存）に含める

## Out of Scope

- カテゴリマスタのユーザー編集（追加/並び替え/削除）
- 高度な分析（カテゴリ別推移グラフ、予算、比率）
- IndexedDB index 追加による高速クエリ（MVP では不要）

---

## MVP Data Spec（提案）

### 1) カテゴリ候補（固定のプリセット + “その他”）

- 収入カテゴリ（例）
  - 給与 / 賞与 / 副収入 / 投資収益 / その他
- 支出カテゴリ（例）
  - 住居 / 光熱 / 食費 / 交通 / 通信 / 保険 / 教育 / 子育て / 医療 / 娯楽 / 旅行 / 税・社保 / 貯蓄・投資 / その他

※最終的には文字列として保存（enum 固定にしない）＝将来拡張しやすい。

### 2) 固定/変動（支出のみ）

- `expenseNature` は支出行で必須に近い（MVP では未設定も許容し、未設定は variable 扱い＋ warning でも可）
- カテゴリ → 固定/変動のデフォルト推定（例）
  - 固定の初期推定：住居/光熱/通信/保険/教育/子育て/税・社保
  - 変動の初期推定：食費/交通/医療/娯楽/旅行/その他/貯蓄・投資（※貯蓄・投資は“任意”扱いでも OK）

---

## UI / UX Requirements

- 各内訳行に追加 UI
  - カテゴリ：Select（未選択は “未分類” 表示）
  - 支出のみ：固定/変動の Segment（固定・変動）
- 入力負担軽減
  - カテゴリを選ぶと固定/変動が自動で入る（手動で切替可能）
- セクション下に小計（支出のみ）
  - 固定費合計（expenseNature=fixed）
  - 変動費合計（expenseNature=variable or undefined）
  - 支出合計（全支出）
- 既存データ互換
  - 既存 items に category/expenseNature が無くても表示が崩れない
  - 未設定は “未分類/変動” として扱う

---

## Technical Notes

- TypeScript 型（B1）更新：
  - `MonthlyItem` に `category?` と `expenseNature?` を追加
- 保存（E6 の replaceItems）にそのまま含める
- IndexedDB
  - objectStore の構造変更は不要（フィールド追加のみ）※index 追加は将来
  - ただし Zod 等スキーマがある場合は更新（将来 J1）
- 集計
  - UI で `items.filter(kind==="expense")` をさらに `expenseNature` で分割して reduce

---

## Acceptance Criteria

- [ ] 月次詳細で内訳行にカテゴリを選択できる（収入/支出）
- [ ] 支出行で固定/変動を選択できる
- [ ] カテゴリ選択時に固定/変動がデフォルト推定で入る（上書き可能）
- [ ] 保存後に再訪するとカテゴリ/固定変動が復元される
- [ ] 支出セクションに固定費合計/変動費合計/支出合計が表示される（UI 集計）
- [ ] 既存データ（category/expenseNature 無し）でも表示が崩れない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載
  - 既存月（未設定）→ カテゴリ付与 → 保存 → 再訪
  - 支出の固定/変動切替 → 小計変化 → 保存 → 再訪
- [ ] lint/typecheck が通る

---

## Dependencies

- E6（月次詳細：内訳 CRUD）
- B1（型更新）
- （任意）A5（表示フォーマット：formatYen）

## Follow-ups

- E8. 内訳 → 合計（MonthlyRecord）への同期方針と自動集計
- E9. カテゴリ別集計ビュー（円グラフ/推移など）

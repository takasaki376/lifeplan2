# Jira チケット（B3）IndexedDB ラッパー実装（CRUD 共通：get/put/delete/list/tx）

## Summary

B3. IndexedDB ラッパー実装（CRUD 共通：get / put / delete / list / tx）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

MVP の永続化は IndexedDB を採用する。  
B2 で定義したスキーマ（objectStore / index / versioning）に基づき、アプリ全体から安全・簡潔に使える **共通ラッパー（DB アクセス基盤）** を実装する。

Repository 層（B4/B5）はこのラッパーに依存し、UI や計算ロジックは Repository を介して DB を操作する。

## Goal

- IndexedDB を直接触らずに済む共通 API を提供する
- トランザクション（readwrite/readonly）を安全に扱える
- B2 の schema version upgrade（onupgradeneeded）をこの層で実装する
- 将来の Store 追加/Index 追加に耐えられる設計にする

---

## In Scope

- IndexedDB のオープン/初期化（openDB）
- onupgradeneeded の実装（B2 のスキーマ反映）
- CRUD 共通関数：
  - get（主キー取得）
  - put（upsert）
  - delete（主キー削除）
  - list（store 全件、または index 経由の絞り込み）
  - tx（複数操作を 1 トランザクションで実行）
- index 経由取得のヘルパー
  - getByIndex（単件）
  - listByIndex（複数）
  - cursor でのページング（任意：最小実装で OK）
- エラーハンドリング方針（例：DB 未対応/upgrade 失敗/transaction abort を握りつぶさない）
- テスト容易性（in-memory 化は B8 で別だが、依存注入しやすい構造）

## Out of Scope

- Repository 実装（B5）
- UI での実際の利用（C/E/F/G…）
- Zod 等の型バリデーション（J1）
- Supabase 実装（B6）

---

## Deliverables

- `src/lib/db/indexeddb.ts`（例）に共通ラッパーを実装
- `src/lib/db/schema.ts`（例）に B2 スキーマ定義（store 名・index 名・version）を定義
- 使用例（README or docs）：
  - 1 件取得・upsert・index 検索・tx 実行のサンプル

---

## API Requirements（ラッパーの公開インターフェース案）

> 最低限これが使えれば B5 が実装できる、という粒度

### 基本

- `openDb(): Promise<IDBDatabase>`（内部で singleton 化推奨）
- `withTx(stores, mode, fn): Promise<T>`（tx 管理の中心）

### CRUD

- `get<T>(storeName, key): Promise<T | undefined>`
- `put<T>(storeName, value, key?): Promise<IDBValidKey>`
- `del(storeName, key): Promise<void>`
- `clear(storeName): Promise<void>`（開発/テスト用：任意）
- `listAll<T>(storeName): Promise<T[]>`（小規模 MVP なので全件 OK）

### Index

- `getByIndex<T>(storeName, indexName, query): Promise<T | undefined>`
- `listByIndex<T>(storeName, indexName, query, options?): Promise<T[]>`
  - options 例：`direction("next"|"prev")`, `limit`, `offset`（offset は無理なら limit+cursor で OK）

### Transaction（重要）

- `txGet/txPut/txDel`（withTx の中で使う版、または withTx 内で store を渡す形でも OK）

---

## Schema Implementation Requirements（B2 準拠）

- DB 名：`lifeplan_mvp`
- 初期 DB version：`1`
- objectStore 作成（最低限）
  - `plans`
  - `planVersions`
  - `scenarioAssumptions`
  - `monthlyRecords`
  - `monthlyItems`
  - `lifeEvents`
  - `housingAssumptions`
- index 作成（B2 の通り）
  - 例：`monthlyRecords.by_planId_ym`（`['planId','ym']` unique）等
- 将来の v2/v3 追加に備え、upgrade 分岐をテンプレ化

---

## Error Handling / Edge Cases

- IndexedDB 未対応環境（SSR/古いブラウザ）を想定し、クライアント限定で開く
  - Next.js App Router での使用は `useEffect` または client component 前提
- open 中の同時呼び出し → Promise singleton で二重 open を防ぐ
- tx 中に例外が出た場合 → transaction abort を明確に返す
- upgrade 失敗時 → エラーを toast 等に表示できるよう throw する

---

## Acceptance Criteria

- [ ] B2 スキーマに基づく DB が `openDb()` で作成/オープンできる
- [ ] `get/put/del/listAll` が動作する（最低限：plans store で検証）
- [ ] `getByIndex/listByIndex` が動作する（例：monthlyRecords の `by_planId_ym` で検証）
- [ ] `withTx` で複数 store の readwrite tx ができる（例：monthlyRecords + monthlyItems を一括更新）
- [ ] open の singleton 化（並列呼び出しでも 1 回の open に収束）
- [ ] upgrade の分岐構造があり、v2 以降の追加がしやすい
- [ ] TypeScript で型パラメータが使え、呼び出し側で型補完が効く（過剰に厳密でなくて OK）

## Definition of Done

- [ ] PR が作成され、基本動作の簡易検証手順が記載されている（README or docs）
- [ ] 代表的な使用例（tx 含む）がコードコメントまたは docs にある
- [ ] lint/typecheck が通る

---

## Suggested Implementation Notes（実装メモ）

- ライブラリ利用方針：
  - **最小実装**：素の IndexedDB + Promise ラップ（推奨）
  - もしくは `idb` ライブラリ採用（導入する場合は A 系 or B3 内で決める）
- `ym` / `startYm` は `"YYYY-MM"` の文字列で統一（文字列ソートで月順が維持される）
- `listByIndex` は cursor を使い、`direction="prev"` で最新を取りやすくする

---

## Dependencies

- B2（IndexedDB スキーマ設計）

## Follow-ups（関連チケット）

- B5. IndexedDB Repository 実装（全 Repo）
- K1. デバッグ用データ初期化（DB 削除 or store clear）
- J2. ユニットテスト（DB ラッパーの軽い検証）

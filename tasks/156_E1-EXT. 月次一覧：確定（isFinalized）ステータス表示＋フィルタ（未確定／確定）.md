# Jira チケット（E1-EXT）月次一覧：確定（isFinalized）表示＋フィルタ拡張

## Summary

E1-EXT. 月次一覧：確定（isFinalized）ステータス表示＋フィルタ（未確定/確定）

## Issue Type

Story（または Task）

## Priority

Medium（運用性向上。締め概念の導入第一歩）

## Background / Context

MVP では「入力済み＝ MonthlyRecord が存在」で十分だが、運用が進むと
「この月は締めた（確定した）ので基本触らない」「未確定だけ見たい」というニーズが出る。
E1（年選択＋未入力/入力済みフィルタ）に対して、確定状態の表示と絞り込みを追加する。

## Goal

- 月次一覧で各月の「確定/未確定」状態が分かる
- フィルタで「未確定のみ」「確定のみ」「すべて」を切り替えられる
- 入力済み判定（record 存在）は維持し、確定は追加の属性として扱う
- 既存データ（isFinalized 未設定）でも破綻しない（未確定扱い）

---

## In Scope

- 月次一覧（`/plans/[planId]/months`）の UI 拡張
  - 行/カードに「確定」バッジ表示
  - ステータスフィルタ追加：
    - すべて
    - 未確定（record あり && isFinalized !== true）
    - 確定（record あり && isFinalized === true）
- データ取り扱い
  - isFinalized が undefined の場合は未確定として扱う
- URL クエリで状態保持（任意だが推奨）
  - `?year=2026&status=input|missing&final=all|open|final`
- ローディング/空状態/エラー表示

## Out of Scope

- 確定/未確定の切替操作（トグルで確定する）※別チケット推奨
- 確定月の編集ロック（編集不可）※別チケット
- 監査ログ/履歴

---

## Functional Requirements

### 1) 表示（バッジ）

- 対象：MonthlyRecord が存在する月のみ
- isFinalized 判定：
  - `true` → バッジ `確定`
  - `false/undefined` → バッジ `未確定`（または表示しない。MVP は「確定だけ表示」でも可）
- 既存の「未入力/入力済み」バッジと併用する場合：
  - 未入力：`未入力`
  - 入力済み & 未確定：`入力済み`（+小さく未確定）
  - 入力済み & 確定：`入力済み` + `確定`

### 2) フィルタ仕様

- 新フィルタ：`finalStatus`
  - `all`：すべて（未入力も含む）
  - `open`：未確定のみ（record あり && isFinalized !== true）
  - `final`：確定のみ（record あり && isFinalized === true）
- 既存の入力状態フィルタ（未入力/入力済み）と組み合わせる場合の優先順位：
  - 推奨：入力状態フィルタの結果に対して finalStatus を適用
  - 例：
    - 入力済み + 確定 → record あり && isFinalized===true
    - 未入力 + 確定 → あり得ないので 0 件

### 3) データ取得と互換性

- E1 の取得結果から isFinalized を参照するだけ（追加 Repo 不要）
- isFinalized が無い旧データは未確定扱いで表示・絞り込み

### 4) 空状態

- フィルタ結果 0 件のとき：
  - `該当する月次がありません`
  - CTA：`フィルタを解除`（finalStatus=all）

---

## UI Requirements

- v0 モック準拠
- フィルタ UI：
  - SegmentedControl / Select で `すべて / 未確定 / 確定`
- バッジ：
  - 確定：強め（例：緑/青）
  - 未確定：控えめ（例：グレー）※表示する場合
- モバイルでも操作しやすい配置

---

## Technical Notes

- `"use client"`
- フィルタ処理は UI 側で OK（MVP）
- URL クエリ保持（任意）：
  - `useSearchParams` + `router.replace`
- 型：
  - `MonthlyRecord.isFinalized?: boolean` を参照
  - 未定義は false と同等に扱う

---

## Acceptance Criteria

- [ ] 入力済み月で isFinalized=true の場合、「確定」バッジが表示される
- [ ] フィルタ「未確定のみ」で、record ありかつ未確定（false/undefined）の月だけ表示される
- [ ] フィルタ「確定のみ」で、record ありかつ確定の月だけ表示される
- [ ] isFinalized 未設定の既存データでも破綻せず未確定扱いになる
- [ ] 既存の「未入力/入力済み」判定（record 存在）を壊さない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 確定あり/なし混在
  - isFinalized 未設定データ
  - フィルタ組み合わせ（入力済み × 確定など）
- [ ] lint/typecheck が通る

---

## Dependencies

- E1（月次一覧 基本実装）
- B5（MonthlyRepo：月次取得/一覧取得）
- （任意）A5（年月表示/共通フォーマット）

## Follow-ups

- E1-FINALIZE：月次の確定/解除アクション（confirm 付き、isFinalized 更新）
- E1-LOCK：確定月の編集ロック（入力/削除の制限）

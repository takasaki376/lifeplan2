# Jira チケット（G5）住宅前提編集：タブ（4 タイプ）＋ かんたん/詳細 切替

## Summary

G5. 住宅前提編集：タブ（4 タイプ）＋ かんたん/詳細 切替（IndexedDB 保存）

## Issue Type

Story（または Task）

## Priority

High（G1/D5 の表示精度と編集導線の中核）

## Background / Context

住宅 LCC 比較（G1）およびダッシュボード LCC サマリー（D5）で、前提が編集できないと運用できない。
MVP では「入力負担を下げる（かんたん）」と「調整可能にする（詳細）」を両立させるため、
4 タイプの前提をタブで切り替えつつ、編集モードを「かんたん/詳細」で切替できる画面を実装する。

永続化は IndexedDB（HousingRepo）を利用する。

## Goal

- 住宅前提編集画面で 4 タイプをタブ切替して編集できる
- 各タイプで「かんたん/詳細」表示を切替できる（値は保持される）
- 変更を保存でき、G1/D5 に反映される
- 未設定でも編集開始できる（雛形生成 or 前提投入誘導）

---

## In Scope

- 画面：`/plans/[planId]/housing/assumptions`
- Repo 連携（現行 Version 前提）：
  - `VersionRepo.getCurrent(planId)`
  - `HousingRepo.listByVersion(planVersionId)`（4 タイプ）
  - `HousingRepo.upsert(...)` または `bulkUpsert(...)`（保存）
- UI：
  - 4 タイプタブ（高性能住宅/一般戸建/分譲マンション/賃貸）
  - かんたん/詳細 トグル（同一タイプ内）
  - 保存ボタン、取消（リセット）、未保存変更の警告（任意）
- バリデーション（MVP 最小）：
  - 金額 >= 0、月額 >= 0、年数/月数 >= 1、率は 0〜100%（内部は 0〜1 でも OK）
- 空状態対応：
  - housing 前提が不足の場合、雛形を作って編集開始（推奨） or `初期前提を作成` CTA

## Out of Scope

- シナリオ前提（conservative/base/optimistic）の編集（別領域）
- LCC 計算ロジック（G9）
- 住替え/売却など高度項目
- 履歴比較（version diff）UI

---

## UI / UX Spec

### 1) 4 タイプタブ

- Tabs:
  - 高性能住宅（high_performance_home）
  - 一般戸建（detached）
  - 分譲マンション（condo）
  - 賃貸（rent）
- タブ切替時：
  - 同一ページ内でフォーム切替（再取得不要）
  - 未保存変更がある場合は confirm（任意：MVP は warning toast でも可）

### 2) かんたん / 詳細 切替

- 目的：入力負担を下げ、必要な人だけ詳細を触れる
- 切替は「表示項目セット」だけ変える（データは共通）
- 表示状態の保持（任意だが推奨）：
  - localStorage に `housingAssumptionsView=basic|detail`

### 3) 入力項目（MVP 案）

#### 共通（全タイプ）

- 光熱（ベース/月額） utilitiesBaseMonthlyYen
- 住宅性能係数 utilitiesFactor（高性能住宅は小さめ初期値）
- 期間（horizonYears）は編集しない（別チケット）。表示だけ `35年` など。

#### 購入系（高性能住宅/一般戸建）

- かんたん：
  - purchasePriceYen（購入価格）
  - downPaymentYen（頭金）
  - interestRateAnnual（ローン金利）
  - termYears（ローン年数）
  - propertyTaxAnnualYen（税：年額概算）
  - repairsAnnualOrSchedule（修繕：年額概算 or 簡易スライダー）
- 詳細：
  - closingCostYen（諸費用）
  - repaymentType（元利均等/元金均等）
  - repairsSchedule（年数 × 費用の配列）
  - maintenanceOtherYen（その他）
  - taxIncreaseRate（任意：未対応なら非表示）

#### 分譲マンション

- かんたん：
  - purchasePriceYen / downPaymentYen / interestRateAnnual / termYears
  - managementFeeMonthlyYen（管理費）
  - repairReserveMonthlyYen（修繕積立）
  - propertyTaxAnnualYen
- 詳細：
  - closingCostYen
  - parkingMonthlyYen
  - oneTimeFees（年数 × 費用）
  - repaymentType

#### 賃貸

- かんたん：
  - rentMonthlyYen（家賃）
  - utilitiesBaseMonthlyYen / utilitiesFactor
  - movingCostYen（引越費：初期）
  - renewalFeeYen（更新料：1 回あたり）
  - renewalCycleYears（更新周期）
- 詳細：
  - rentIncreaseRate はシナリオ側に寄せる想定（ここでは表示しない）
  - 初期費用（敷金/礼金など）をまとめて initialOtherYen（任意）

※実際のフィールド名は B1 の型に合わせる。上記は「表示セット」の指針。

### 4) 保存

- 保存単位：現在のタブ（1 タイプ）だけ保存 でも、全タイプ一括保存でも OK
  - MVP 推奨：**「保存」は全タイプ一括**（一貫性・実装簡易）
- `Save`：
  - validate → HousingRepo.bulkUpsert(planVersionId, updatedHousingList)
  - toast：`保存しました`
- `Reset`（任意）：
  - 画面読み込み時点の値に戻す（state reset）

### 5) 反映先

- G1：比較トップの各タイプ計算に反映
- D5：選択中タイプのサマリーに反映
  （どちらも mount 時の再取得で反映される前提。必要ならリロード誘導なしで自然反映）

---

## Technical Notes

- `"use client"`（IndexedDB）
- 状態設計：
  - 画面初期で housingList を取得 → `byTypeMap` に正規化してフォームに流し込む
  - かんたん/詳細切替は “表示する fields 配列” を切り替えるだけ
- バリデーション：
  - zod 等を使うなら「かんたん/詳細で必須項目が変わらない」よう注意
  - 例：詳細項目は optional のまま
- 未保存変更（dirty）：
  - `initialSnapshot` と比較（deepEqual） or `dirty` フラグ
  - タブ切替/画面離脱時に confirm（任意）

---

## Acceptance Criteria

- [ ] `/plans/[planId]/housing/assumptions` で 4 タイプがタブ表示される
- [ ] タブを切り替えて各タイプの前提を編集できる
- [ ] 「かんたん/詳細」切替で表示項目が変わるが、入力済みの値は保持される
- [ ] 保存すると IndexedDB に永続化され、再訪しても値が復元される
- [ ] 前提が不足していても編集開始できる（雛形生成 or 作成 CTA）
- [ ] 金額/年数など最低限のバリデーションが効く
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 4 タイプ編集 → 保存 → 再訪復元
  - かんたん/詳細切替で値が消えない
  - 未保存状態でタブ切替（confirm/警告の挙動）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（VersionRepo / HousingRepo）
- C3（初期前提投入：あると検証が容易。無い場合は G5 で雛形生成が必要）
- A5（formatYen：表示がある場合）
- （任意）G9（保存後に G1/D5 で数値変化確認する場合）

## Follow-ups

- G5-1：前提編集の「初期化（デフォルトに戻す）」機能
- G5-2：入力補助（スライダー、プリセット、ツールチップ）
- G5-3：scenario も含めた編集導線の統一（別領域）

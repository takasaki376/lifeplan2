# Jira チケット（E3）月次かんたん入力：対象月の読み込み・保存（upsert）

## Summary

E3. 月次かんたん入力：対象月の読み込み・保存（upsert）

## Issue Type

Story（または Task）

## Priority

High

## Background / Context

v0 で「月次入力（かんたん）」画面の UI モックは作成済み。  
MVP では永続化が IndexedDB であるため、B5 で実装した `MonthlyRepository` を使って、対象月（ym）のデータを **読み込み → 編集 → 保存（upsert）** できるようにする。

この画面は継続管理のコア導線（ダッシュボード → 今月入力）であり、最優先で“動く”状態にする。

## Goal

- 対象月（current または指定 ym）の `MonthlyRecord` を読み込み、フォームに反映する
- 「保存して戻る」で `upsert` し、ダッシュボード/対象月画面へ遷移できる
- 未入力/月次データ無しの場合は空状態で開始し、保存で新規作成される

---

## In Scope

- 画面：`/plans/[planId]/months/current` および `/plans/[planId]/months/[yyyy-mm]`（プロジェクト方針に合わせる）
- 対象月の決定（current → 今月の `YYYY-MM`、指定 → その `YYYY-MM`）
- `MonthlyRepository.getByYm(planId, ym)` による初期ロード
- 入力値の編集（収入合計/支出合計/資産残高/負債残高）
- 保存（upsert）
  - 既存があれば更新
  - 無ければ新規作成
- 保存完了後の遷移
  - 基本：`/plans/[planId]`（ダッシュボード）へ戻る
  - もしくは `/plans/[planId]/months/[yyyy-mm]` に戻る（画面設計に従う）
- toast 表示（保存成功/失敗）

## Out of Scope

- 前月コピー（E4）
- 収支自動計算表示（E5） ※UI 表示はあってもロジック確定は E5
- 詳細内訳（E6 以降）
- 月次削除（E10）

---

## Functional Requirements

### 1) 対象月（ym）の決定

- `current` の場合：クライアントで現在日付から `YYYY-MM` を生成
- `[yyyy-mm]` の場合：URL パラメータをそのまま `ym` として扱う
- 共通ユーティリティを使う（例：`formatYearMonth(new Date())`）

### 2) 初期ロード

- 画面マウント時に以下を実行：
  - Plan の存在確認（PlanRepository.get(planId) ※任意だが推奨）
  - MonthlyRecord 取得：`MonthlyRepository.getByYm(planId, ym)`
- 既存あり：
  - フォームに値をセット
  - ステータス「入力済み」、最終更新日を表示（updatedAt）
- 既存なし：
  - フォーム空で開始
  - ステータス「未入力」

### 3) 入力仕様（MVP 最小）

- 対象フィールド（4 ボックス）
  - `incomeTotalYen`
  - `expenseTotalYen`
  - `assetsBalanceYen`
  - `liabilitiesBalanceYen`
- バリデーション（優しく）
  - 0 以上（負数禁止）
  - 空は許容（ただし保存時に 0 扱い or undefined のまま、方針を統一）
- 表示フォーマットは UI 側で可能（保存値は number）

### 4) 保存（upsert）

- 保存ボタン：
  - 「保存して戻る」（主）
  - （任意）「保存」（戻らない）
- 保存時の処理：
  - 既存 record がある：id を維持して更新（updatedAt 更新）
  - 無い：新規作成（id 生成、createdAt/updatedAt 付与）
- Repo 利用（推奨）：
  - `MonthlyRepository.upsertByYm(planId, ym, patch)` を使用
  - もしくは `upsert(record)`（record 組み立て）

### 5) 保存後の挙動

- toast：`"保存しました"`
- 遷移：
  - 基本はダッシュボード：`/plans/[planId]`
- 失敗時：
  - toast：`"保存に失敗しました"`（詳細は console で OK）
  - 画面は留まる

---

## UI Requirements（このチケットで触る範囲）

- ローディング表示（Skeleton or “読み込み中”）
- 保存中はボタン disabled + スピナー（任意）
- 既存/未入力のバッジ表示（UI にある前提）
- スマホでフッター固定ボタンがある場合も保存ロジックは共通

---

## Technical Notes

- `"use client"` コンポーネントで実装（IndexedDB のため）
- Repo はコンポーネント内で import し、`useEffect` でロード
- `ym` は `"YYYY-MM"` を厳守（B1/B2 の設計に合わせる）
- id 生成は Repo 側推奨（`crypto.randomUUID()`）※SSR 注意（client のみ）
- createdAt/updatedAt は Repo 側で付与（UI は気にしない）

---

## Acceptance Criteria

- [ ] `/plans/[planId]/months/current` で今月の record がロードできる（無ければ空）
- [ ] `/plans/[planId]/months/[yyyy-mm]` で指定月の record がロードできる
- [ ] 4 項目を入力して保存すると、IndexedDB に作成/更新される（upsert）
- [ ] 保存後に toast が表示され、ダッシュボードへ戻れる
- [ ] 既存 record がある場合、編集 → 保存で値が更新される
- [ ] エラー時は toast 表示され、データは壊れない

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載（例：今月 → 保存 → 再表示、別月 → 保存 → 再表示）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（MonthlyRepository 実装）
- （推奨）C 系（Plan 存在チェックをしたい場合は PlanRepo）

## Follow-ups（関連チケット）

- E4. 前月コピー機能
- E5. 収支自動計算表示
- E10. 月次削除

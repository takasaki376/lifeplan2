# Jira チケット（G9）LCC 計算モジュール実装（内訳：初期/ローン or 家賃/税/修繕 or 管理/光熱）

## Summary

G9. LCC 計算モジュール実装（内訳：初期/ローン or 家賃/税/修繕 or 管理/光熱）

## Issue Type

Story（または Task）

## Priority

High（住宅 LCC 比較の中核ロジック）

## Background / Context

住宅 LCC 比較は MVP の主要機能。Knowledge で定義された最低限内訳（初期費用、ローン、税、修繕、光熱、賃貸の更新/引越等）を分解し、
前提パラメータ（かんたん → 詳細）から一貫して計算できる共通モジュールを実装する。
※住替え（売却/建替え/引越の確率）は MVP では任意とし、計算からは切り離す。

## Goal

- 住宅タイプ別に LCC（合計）と内訳（カテゴリ別）を算出できる
- 月次（or 年次）のキャッシュフロー列を生成できる（比較グラフに使える）
- “概算/前提依存” を前提に、入力不足でも破綻しない（不足時は 0 or warning）
- 将来の精緻化（税・売却・NPV）に差し替えしやすい構造にする

---

## In Scope（内訳カテゴリ：最低限）

- 初期費用：頭金/諸費用
- 住宅ローン：金利・期間・返済方法（元利均等/元金均等）
- 税：固定資産税等（概算モデル）
- 修繕：定期/大規模（周期と単価）
- 管理：マンション（管理費/修繕積立/一時金/駐車場）
- 光熱費：住宅性能差を係数化（utilitiesFactor）
- 賃貸：家賃、家賃上昇、更新料、引越費（初期/更新）

## Out of Scope（MVP では任意/将来）

- 売却損益・住替え確率モデル
- 税の厳密計算（地域・控除完全対応）
- 住宅ローン控除などの制度反映
- 運用利回りとの統合最適化（機会費用）

---

## Inputs（想定）

- HousingAssumptions（housingType 別）
- ScenarioAssumptions（インフレ率など。MVP では主に家賃上昇/光熱費上昇/税上昇の伸びに使用）
- 計算期間：
  - horizonMonths（default 420）
  - startYm（任意：キャッシュフローの起点）

### housingType

- high_performance_home（高性能住宅）
- detached（一般戸建）
- condo（分譲マンション）
- rent（賃貸）

---

## Output（必須）

### 1) LccSummary

- totalNominalYen（名目合計）
- breakdownNominalYen
  - initial
  - loanOrRent
  - tax
  - repairsOrManagement
  - utilities
  - other（更新料/引越等）
- warnings: string[]（前提不足/推定扱い 等）

### 2) CashflowSeries（比較グラフ用）

- months: { ym, initial, loanOrRent, tax, repairsOrManagement, utilities, other, total }[]（長さ=horizonMonths）
- optional: yearly aggregated（後で追加でも OK）

### 3) Optional（将来拡張用）

- totalPresentValueYen（割引現在価値：discountRate が指定された場合のみ）
- breakdownPresentValueYen（同上）

---

## Calculation Spec（MVP の計算ルール）

### A) 初期費用

- initial = downPaymentYen + closingCostYen + (initialOtherYen)
- 賃貸は敷金礼金等を initialOther として扱える（未入力なら 0）

### B) ローン（購入系）

- repaymentType:
  - annuity（元利均等）
  - equal_principal（元金均等）
- loanPrincipal = purchasePriceYen - downPaymentYen（未入力は 0 扱い）
- interestRateAnnual, termMonths を用いて月次返済額を算出
  - 元利均等：PMT 式
  - 元金均等：元金一定 + 利息（残高 × 金利/12）
- ※MVP は厳密で OK（実装コスト小）。round は最終的に円単位。

### C) 家賃（賃貸）

- rentMonthlyYen をベースに、
- rentIncreaseRateAnnual（or inflationRate）で年次更新（毎年 1 月 or 契約開始月で更新：MVP は“年次 1 回”で OK）
- 更新料：
  - renewalFeeYen があり renewalCycleYears がある場合、周期ごとに発生
- 引越費：
  - movingCostYen を初期（0 ヶ月目）に計上（MVP）

### D) 税（購入系）

- propertyTaxAnnualYen を年次で配賦（/12）して計上
- 税の伸び：
  - inflationRate を使って年次で増額（任意：MVP は固定でも OK、ただしオプションで）

### E) 修繕（戸建）

- repairsSchedule: { atYear, costYen }[] を年次でイベント計上
- 住宅タイプごとにデフォルトを C3 で投入済み（編集可能）
- cost の伸び：inflationRate で増額（任意）

### F) 管理（分譲マンション）

- managementFeeMonthlyYen
- repairReserveMonthlyYen
- parkingMonthlyYen
- oneTimeFees: { atYear, costYen }[]（任意）
- 伸び：inflationRate で増額（任意）

### G) 光熱（全タイプ）

- utilitiesBaseMonthlyYen \* utilitiesFactor を月次計上
- 伸び：inflationRate で増額（任意）

### H) 合計

- 月次 total = initial(0 ヶ月目のみ) + loanOrRent + tax + repairsOrManagement + utilities + other
- totalNominalYen = sum(monthly total)

### I) 不足値の扱い（重要）

- undefined / null は 0 扱い（warnings に「未入力のため 0 として扱った」）
- 必須級（例：rentMonthlyYen が未入力の賃貸）でも、計算は落とさず total=0 + warning で返す
- UI 側で「前提不足」表示に使う

---

## Deliverables

- `src/lib/calc/lcc/` 配下に実装（例）
  - `types.ts`（入出力型）
  - `loan.ts`（返済計算）
  - `rent.ts`（賃貸 CF）
  - `utilities.ts`（光熱）
  - `tax.ts`（固定資産税）
  - `repairs.ts` / `management.ts`
  - `calcLcc.ts`（統合：housingType で分岐）
- ユニットテスト（最低限）
  - ローン元利均等の月次返済
  - 賃貸の家賃上昇＆更新料
  - repairsSchedule の年次イベント計上
- 仕様メモ：`docs/lcc-calculation.md`（任意だが推奨）

---

## Acceptance Criteria

- [ ] 4 住宅タイプ（高性能住宅/一般戸建/分譲マンション/賃貸）で LccSummary が返る
- [ ] breakdown（初期/ローン or 家賃/税/修繕 or 管理/光熱/その他）がカテゴリ別に一致する
- [ ] horizonMonths=420（35 年）で月次キャッシュフロー配列を生成できる
- [ ] 前提が欠けても例外で落ちず、warnings で不足を返す
- [ ] ローン返済（元利均等/元金均等）が計算できる
- [ ] 主要ケースのユニットテストが通る
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 計算結果を D5/G1（表示側）から呼べる状態になっている
- [ ] docs（またはコメント）に「概算/前提依存」「MVP の非対象（売却等）」が明記されている

---

## Dependencies

- B1（型）
- C3（初期前提投入：repairs/management/rent 等の雛形）
- A5（format 系は表示側だが、テスト出力確認に便利）
- G1/G5（UI 側で利用して検証する場合）

## Follow-ups

- 売却/住替え（任意）を add-on として追加
- 割引現在価値（NPV）対応（discountRate）
- 税モデル精緻化（地域差/控除）

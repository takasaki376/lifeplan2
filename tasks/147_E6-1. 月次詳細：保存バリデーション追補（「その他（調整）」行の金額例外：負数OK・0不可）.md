# Jira チケット（E6-1）月次詳細：保存バリデーション追補（「その他（調整）」行の例外）

## Summary

E6-1. 月次詳細：保存バリデーション追補（「その他（調整）」行の金額例外：負数 OK・0 不可）

## Issue Type

Task

## Priority

High（E9 の差額吸収アクション成立に必須）

## Background / Context

E6 では内訳行の保存バリデーションとして「金額 > 0」を採用している。  
しかし E9 の統一仕様では、差額を「その他（調整）」行として内訳に吸収し、合計と一致させるため、
調整行は差額次第で負の金額になり得る。  
そのため、E6 の保存バリデーションに「調整行のみ例外」を追加する。

## Goal

- 通常の内訳行は従来通り `amountYen > 0` を維持
- 「その他（調整）」行は `amountYen !== 0` を許容（負数 OK）
- UI で分かりやすいエラー表示を維持しつつ、E9 の吸収後に保存できる

---

## In Scope

- 月次詳細（E6）の保存前バリデーション関数の追補
- 調整行の判定ロジック追加
- 0 円の調整行を禁止（無意味な行の残存防止）
- エラーメッセージ整備（通常行と調整行で文言を変える）

## Out of Scope

- 調整行の自動生成（E9 側）
- カテゴリマスタ化
- Undo/取り消し

---

## Spec（バリデーション仕様）

### 1) 調整行判定

- `isAdjustmentItem(item)` を追加（関数化推奨）
  - 判定条件（MVP）：
    - `item.name === "その他（調整）"`
  - 任意で堅牢化（将来）：
    - `&& item.category === "その他"`

### 2) 金額ルール

- 通常行（isAdjustmentItem=false）：
  - `amountYen` は数値で `> 0` 必須
- 調整行（isAdjustmentItem=true）：
  - `amountYen` は数値で `!== 0`（負数 OK）

### 3) 既存ルールの維持

- `name` 必須（空は不可）…調整行も必須（固定名なので通常 OK）
- `amountYen` 数値化できない場合は不可（パース失敗）

### 4) エラーメッセージ例

- 通常行：`金額は1円以上を入力してください`
- 調整行：`調整行の金額は0円にできません（差額がない場合は行を削除してください）`

---

## Implementation Notes

- 既存の `validateMonthlyItems(items)`（仮）に `isAdjustmentItem` 分岐を追加
- E9 の吸収アクションで `delta === 0` の時は調整行を作らない（E9 側の前提）
- すでに調整行があり `amountYen` が 0 になった場合：
  - 保存不可にする（本チケットの仕様）
  - 将来は「0 になったら自動削除」も検討（今回は Out of Scope）

---

## Acceptance Criteria

- [ ] 通常の内訳行は `amountYen > 0` を要求し、0/負数で保存できない
- [ ] 「その他（調整）」行は負数でも保存できる
- [ ] 「その他（調整）」行が 0 の場合は保存できず、適切なエラーが出る
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順を PR に記載
  - 通常行：0/負数 NG
  - 調整行：負数 OK
  - 調整行：0NG
- [ ] lint/typecheck が通る

---

## Dependencies

- E6（月次詳細：内訳 CRUD）
- E9（差額吸収統一仕様）※この追補がないと E9 後の保存で詰む可能性

## Follow-ups

- 調整行の 0 円自動削除（任意）
- 調整行の表示固定（常に最下部、折りたたみ）

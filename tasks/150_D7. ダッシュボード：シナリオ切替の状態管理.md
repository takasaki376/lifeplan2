# Jira チケット（D7）ダッシュボード：シナリオ切替の状態管理（URL クエリ or local state）

## Summary

D7. ダッシュボード：シナリオ切替の状態管理（URL クエリ優先 / local state fallback）

## Issue Type

Task（または Story）

## Priority

Medium（カードの表示切替基盤。D5/G1 と連動で価値が出る）

## Background / Context

本アプリは前提の見直し・シナリオ比較（保守/標準/楽観）が前提。  
ダッシュボード上でシナリオを切り替え、住宅 LCC や将来指標（将来拡張）の表示を同一画面で比較できる状態を作る。

MVP では「切替状態の管理」と「他コンポーネントが参照できる形」の整備が目的。

## Goal

- ダッシュボード上でシナリオ（conservative/base/optimistic）を切り替えられる
- 状態が URL クエリで表現され、リロード・共有・戻る/進むで復元できる
- 不正な値は base にフォールバックする
- 子コンポーネント（D5/D6/D3 等）が selectedScenario を参照できる

---

## In Scope

- 画面：`/plans/[planId]`（ダッシュボード）
- シナリオ切替 UI（Segment/Select/Tab）を実装 or 既存モックに接続
- 状態管理方式
  - URL クエリ：`?scenario=base`（推奨）
  - fallback：local state（URL が無い/不正時）
- `selectedScenario` をダッシュボードの共通 state として保持し、下位カードに props で渡す（MVP）
- util/型：
  - ScenarioKey 型定義
  - parse/serialize 関数
- ルーティング更新（push/replace の方針を定義）

## Out of Scope

- シナリオの永続保存（ユーザー設定として保存）
- 複数シナリオの同時比較（並列グラフ表示）
- シナリオごとの前提編集 UI（住宅前提編集側で対応）

---

## Spec

### 1) ScenarioKey

- 値：`conservative | base | optimistic`
- 表示ラベル：`保守 | 標準 | 楽観`

### 2) URL クエリ仕様（推奨）

- パラメータ名：`scenario`
- 例：`/plans/123?scenario=optimistic`
- パース：
  - 未指定 → `base`
  - 不正値 → `base`
- シリアライズ：
  - 切替時に `scenario` を更新
  - 既存の他クエリは保持して更新（例：`?scenario=...&tab=...`）

### 3) push / replace 方針

- 推奨：`router.replace`（シナリオ切替で履歴が増えすぎない）
- 比較検証用途を重視するなら `router.push` でも OK（ただし履歴が増える）
- MVP は replace を採用

### 4) local state fallback

- `scenarioParam` が無い場合でも UI は動くように `useState("base")` を初期値にし、
  param がある場合はそれを優先する（同期は useEffect）
- ただし「URL が真実（source of truth）」に寄せる（MVP の一貫性）

### 5) 下位コンポーネントへの受け渡し

- `selectedScenario` を Dashboard で決定し、
  - D5（住宅 LCC サマリー）
  - D6（直近イベント）
  - D3（今月カード）
    など必要なカードに props で渡す（MVP）
- G1（住宅比較トップ）など他画面は別チケットで同様の仕組みを実装（将来）

---

## UI Requirements

- v0 モック準拠のシナリオ切替 UI
  - Segment（3 ボタン）推奨：保守/標準/楽観
- 選択中が明確に分かる（active state）
- 切替時にページ全体がガタつかない（カードは再計算/再描画のみ）

---

## Technical Notes

- Next.js App Router 想定
- 実装候補（例）
  - `src/lib/scenario.ts`
    - `export type ScenarioKey = ...`
    - `export const scenarioKeys = [...] as const`
    - `export function parseScenario(v: string | null | undefined): ScenarioKey`
  - Dashboard 側で
    - `const searchParams = useSearchParams()`
    - `const router = useRouter()`
    - `const scenario = parseScenario(searchParams.get("scenario"))`
    - onChange で `router.replace(...)`
- 画面内で共通に使うなら Context 化も可（MVP は props で OK）

---

## Acceptance Criteria

- [ ] ダッシュボードでシナリオ切替 UI が表示される
- [ ] 切替すると URL の `scenario` が更新される（replace）
- [ ] リロードしても選択状態が復元される
- [ ] 不正な `scenario` が指定されても base にフォールバックする
- [ ] selectedScenario が下位カードに渡される（少なくとも D5 に渡せる）
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載（URL 直打ち、不正値、切替、リロード）
- [ ] lint/typecheck が通る

---

## Dependencies

- D1（ダッシュボード基盤）
- D5/G1（シナリオにより表示が変わるカードがあると動作確認しやすい）
- （任意）C3（3 シナリオ初期前提投入。将来的に実データと紐づける）

## Follow-ups

- シナリオ既定値を Plan/Version 設定として保存（Supabase 移行時）
- G1（住宅比較）でも同じクエリ仕様で統一
- シナリオ比較（2 つ並列表示）機能

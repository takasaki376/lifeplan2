# Jira チケット（E8）月次詳細：合計整合（内訳合計 vs かんたん合計）差分表示

## Summary

E8. 月次詳細：合計整合（内訳合計 vs かんたん合計）差分表示＋反映（同期）導線

## Issue Type

Story（または Task）

## Priority

High（データの整合性・ユーザー信頼に直結）

## Background / Context

MVP では「かんたん入力」で月次合計（収入合計/支出合計等）を保存でき、さらに「月次詳細」で内訳行（incomeItems/expenseItems）を保存できる。
しかし両者は別入力のため、合計がズレる（不整合）可能性が高い。  
E8 では、内訳合計と MonthlyRecord 合計の差分を明示し、ユーザーが意図して整合させられる導線を提供する。

## Goal

- 月次詳細画面で「内訳合計」「かんたん合計」「差分（Δ）」を表示できる
- 差分がある場合に分かりやすい警告と、1 クリックで整合（反映）できる
- 反映後、MonthlyRecord と内訳合計が一致する
- 未入力・欠損ケースでも破綻しない（0 扱い/—/警告）

---

## In Scope

- 画面：`/plans/[planId]/months/[yyyy-mm]/detail`
- IndexedDB（Repo）連携：
  - MonthlyRecord 取得：`MonthlyRepo.getByYm(planId, ym)`
  - MonthlyItem 取得：`MonthlyRepo.listItems(monthlyRecordId)`
  - MonthlyRecord 更新：`MonthlyRepo.upsertByYm(planId, ym, { incomeTotalYen, expenseTotalYen })`
- 差分表示 UI（サマリー領域）
  - 収入：内訳合計 / かんたん合計 / Δ
  - 支出：内訳合計 / かんたん合計 / Δ
  - （任意）収支：内訳ベース / かんたんベース / Δ
- 同期アクション（MVP 最小）
  - 「内訳合計をかんたん合計に反映」ボタン（収入/支出 個別 or 一括）
- 反映後の toast・再計算・表示更新
- ローディング/エラー表示

## Out of Scope

- 「かんたん合計 → 内訳を自動生成（逆同期）」機能
- 詳細内訳のカテゴリ別集計（E9）
- 自動同期（保存時に強制一致）※将来検討
- イベント反映による自動補正（I2）

---

## Functional Requirements

### 1) 前提解決（MonthlyRecord / monthlyRecordId）

- `record = MonthlyRepo.getByYm(planId, ym)`
- record が無い場合：
  - 方針 A（推奨）：詳細画面で自動作成（空の合計で OK）
    - `record = MonthlyRepo.upsertByYm(planId, ym, {})`
  - 以降の処理は record.id を使う

### 2) 内訳合計の計算

- `items = MonthlyRepo.listItems(record.id)`
- incomeItems 合計：`items.filter(kind==="income").reduce(sum(amountYen))`
- expenseItems 合計：`items.filter(kind==="expense").reduce(sum(amountYen))`
- amountYen が undefined/NaN の場合は 0 扱い（ただし警告対象にしてもよい）

### 3) かんたん合計の参照

- easyIncome = record.incomeTotalYen ?? 0（未入力は 0 相当、表示は方針で “—” でも可）
- easyExpense = record.expenseTotalYen ?? 0

### 4) 差分（Δ）の算出と表示

- deltaIncome = (easyIncome) - (incomeItemsTotal)
- deltaExpense = (easyExpense) - (expenseItemsTotal)
- 表示：
  - 差分が 0 の場合：`一致`（success）
  - 差分が非 0 の場合：`差分あり（+/-）`（warning）
- しきい値：
  - `abs(delta) >= 1` で差分扱い（円単位）

### 5) 反映（同期）アクション（MVP）

- ボタン（差分がある場合のみ表示）：
  - `内訳合計をかんたん合計に反映（収入）`
  - `内訳合計をかんたん合計に反映（支出）`
  - （任意）`両方反映`
- 実行内容：
  - 収入：`MonthlyRepo.upsertByYm(planId, ym, { incomeTotalYen: incomeItemsTotal })`
  - 支出：`MonthlyRepo.upsertByYm(planId, ym, { expenseTotalYen: expenseItemsTotal })`
- 実行後：
  - toast：`反映しました`
  - record 再取得 or state 更新で差分表示が 0 になる

### 6) UI/UX（サマリー領域の仕様）

- サマリーカード（上部固定推奨）に以下を表示：
  - 収入：内訳合計 / かんたん合計 / Δ
  - 支出：内訳合計 / かんたん合計 / Δ
  - 収支（任意）：（収入-支出）を両方のベースで表示
- 差分ありの場合：
  - 注意文：`内訳合計とかんたん合計が一致していません。どちらを正とするか選んで反映してください。`
  - 反映ボタンを表示
- 表示フォーマット：
  - `formatYen()`（A5）で統一

### 7) エラー/ローディング

- items 取得中：サマリーも Skeleton
- 反映中：ボタン disabled（二重送信防止）
- 取得/更新失敗：
  - toast：`取得/反映に失敗しました`

---

## Technical Notes

- `"use client"`（IndexedDB）
- 可能なら E6 の items state を流用し、保存直後に totals を再計算して即反映（再 fetch 不要）
- “差分表示・反映”ロジックを関数化：
  - `computeMonthlyTotals(record, items)` → { incomeItemsTotal, expenseItemsTotal, easyIncome, easyExpense, deltaIncome, deltaExpense }
- 反映先は MonthlyRecord の incomeTotalYen / expenseTotalYen（D3 や E3 が参照するため）

---

## Acceptance Criteria

- [ ] 月次詳細で「内訳合計」「かんたん合計」「差分」が収入/支出それぞれ表示される
- [ ] 差分が 0 なら「一致」表示、差分があれば警告表示になる
- [ ] 差分あり時に「内訳合計をかんたん合計に反映」ボタンが表示される
- [ ] 反映すると MonthlyRecord が更新され、差分が 0 になる
- [ ] 未入力（record 無し）でも詳細画面で破綻せず、差分表示が成立する（方針 A の場合は自動作成）
- [ ] ローディング/エラー時の表示がある
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 内訳追加 → 差分発生 → 反映 → 一致になる
  - 収入のみ/支出のみ差分のケース
  - record 無しからの開始
- [ ] lint/typecheck が通る

---

## Dependencies

- E6（月次詳細：内訳 CRUD）
- E3（月次かんたん入力：MonthlyRecord upsert）
- B5（MonthlyRepo：getByYm / upsertByYm / listItems / replaceItems）
- A5（formatYen：推奨）

## Follow-ups（関連チケット）

- E8+：逆同期（かんたん合計 → 内訳を自動生成する補助）
- E5/D3：表示側の収支計算を「どの合計を採用するか」方針確定（items 優先など）
- E9：カテゴリ別集計ビュー

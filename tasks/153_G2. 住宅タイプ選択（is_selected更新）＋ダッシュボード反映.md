# Jira チケット（G2）住宅タイプ選択（is_selected 更新）＋ダッシュボード反映

## Summary

G2. 住宅タイプ選択（isSelected 更新）＋ダッシュボード反映（選択中タイプを切替できる）

## Issue Type

Story（または Task）

## Priority

High（住宅比較の基本操作。D5 の表示内容にも直結）

## Background / Context

住宅 LCC 比較トップ（G1）で 4 タイプを並べても、「どれを選択中（採用）にするか」を切り替えられないと運用できない。
また、ダッシュボード（D5）は選択中タイプ（isSelected=true）を表示するため、選択変更が即反映される必要がある。
MVP は IndexedDB 永続化のため、HousingRepo を通して isSelected を更新し、表示側を再描画する。

## Goal

- G1（住宅 LCC 比較トップ）で「このタイプを選択」できる
- 同一 version 内で isSelected=true が常に 1 つになる（排他制御）
- 選択変更が IndexedDB に保存される
- ダッシュボード（D5）で選択中タイプが更新される（再訪/リロードでも保持）

---

## In Scope

- UI（G1）
  - 各住宅タイプカードに `選択する` ボタン（またはラジオ/セグメント）を実装
  - 選択中は `選択中` バッジ/強調表示
- 永続化（Repo 連携）
  - `HousingRepo.setSelected(planVersionId, housingType)` を呼ぶ（推奨）
  - または `listByVersion` → selected 付け替え → `bulkPut` 相当（tx で）
- 反映（D5）
  - D5 は `HousingRepo.listByVersion(...)` から `isSelected` を参照して表示するため、
    選択変更後にダッシュボードで再取得すれば反映される（最小実装）
- UX
  - 実行中 disabled（二重送信防止）
  - 成功/失敗 toast
  - 選択変更後の表示更新（G1 内は即時にバッジ切替）

## Out of Scope

- 選択の履歴（いつ変更したかの監査ログ）
- 複数タイプ同時選択
- シナリオ（conservative/base/optimistic）ごとに別選択（将来）

---

## Functional Requirements

### 1) 排他制御（同一 Version 内で 1 つだけ選択）

- 選択操作：`selectHousingType(planVersionId, housingType)`
- ルール：
  - 対象 type を `isSelected=true`
  - その他 type を `isSelected=false`
  - 結果として true は必ず 1 つ（または前提不足時は 0 もあり得るが、MVP は 1 を推奨）

### 2) Repository API（推奨）

- `HousingRepo.setSelected(planVersionId: string, type: HousingType): Promise<void>`
  - tx 内で `listByVersion` → update → bulkPut
  - 失敗時は例外 throw

### 3) G1 UI 仕様

- 各カードにボタン：
  - 未選択：`このタイプを選択`
  - 選択中：disabled or `選択中`
- 選択切替成功後：
  - UI 上の選択状態が即時更新（バッジ/枠線）
  - toast：`選択中の住宅タイプを更新しました`

### 4) ダッシュボード反映（D5）

- D5 は選択中タイプを `housingList.find(h => h.isSelected)` で決定
- 反映の確認方法（MVP）
  - 選択後にダッシュボードへ戻ると、D5 が最新の isSelected を表示
- さらに確実にする方法（任意）
  - ダッシュボードが `focus` されたら再取得（route change / visibilitychange）
  - もしくは簡易イベントバス（localStorage event など）で「selected 変更」を通知
  - ただし MVP は「画面マウント時の再取得」で十分

### 5) エラー/前提不足

- housingList が揃っていない場合：
  - 選択ボタンを非表示 or disabled
  - メッセージ：`前提が不足しています。前提を編集してください`
- Repo 更新失敗：
  - toast：`更新に失敗しました`
  - UI 状態はロールバック（state を元に戻す）

---

## UI Requirements

- v0 モック準拠の 4 カード
- 選択中は視覚的に明確（枠線・バッジ）
- ボタンは誤操作防止のためカード下部に配置
- 実行中は二重押下不可

---

## Technical Notes

- `"use client"`（IndexedDB）
- 実装候補
  - `src/lib/usecases/selectHousingType.ts`
    - repo を呼び出す薄いユースケース層
  - G1 で呼ぶ（onClick）
- Repo 実装（B5）側で tx を使い排他制御する
- ダッシュボード反映は「取得に依存」するため、
  - D5 は mount 時に `HousingRepo.listByVersion` を必ず呼ぶ（D1/D5 内で）

---

## Acceptance Criteria

- [ ] G1 で任意の住宅タイプを選択できる
- [ ] 同一 version 内で isSelected=true が常に 1 つになる
- [ ] リロードしても選択状態が保持される（IndexedDB 保存）
- [ ] ダッシュボード（D5）で選択中タイプが更新される（遷移後に反映）
- [ ] 成功/失敗の toast が表示される
- [ ] 実行中は二重送信できない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - タイプ A 選択 → 選択中表示
  - タイプ B に切替 →A が未選択になり B が選択中
  - ダッシュボードに戻る →D5 の選択中タイプが切り替わっている
  - リロード → 状態保持
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（HousingRepo 実装：listByVersion / bulkPut / setSelected）
- G1（比較トップ UI）
- D5（選択中タイプ表示）
- （任意）C3（初期前提投入：4 タイプが揃うと検証が容易）

## Follow-ups

- D5 からも選択変更できる導線（将来）
- 選択変更の履歴（監査・バージョン差分）

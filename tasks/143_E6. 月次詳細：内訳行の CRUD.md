# Jira チケット（E6）月次詳細：内訳行の CRUD（incomeItems/expenseItems）

## Summary

E6. 月次詳細：内訳行の CRUD（incomeItems / expenseItems）— 追加・編集・削除・保存（IndexedDB）

## Issue Type

Story（または Task）

## Priority

High（詳細入力の基盤。以降の自動集計（E7/E8）に直結）

## Background / Context

月次の「かんたん入力」は合計値だが、継続管理では内訳（固定費・変動費など）の記録が重要。  
v0 で月次詳細入力の UI モックは作成済みのため、本チケットでは内訳行の CRUD を実装し、IndexedDB に保存できる状態を作る。

## Goal

- 月次詳細画面で収入/支出の内訳行を追加・編集・削除できる
- 既存内訳を読み込み表示できる
- 保存で IndexedDB に永続化され、再訪時に復元できる
- 未入力（月次 record が無い）でも詳細入力を開始できる（必要なら record を先に作る）

---

## In Scope

- 画面：`/plans/[planId]/months/[yyyy-mm]/detail`
- 対象月の MonthlyRecord の解決（なければ作成 or 作成誘導）
- MonthlyItem の読み込み/表示
  - `MonthlyRepository.listItems(monthlyRecordId)`
- 内訳行 CRUD（UI + state）
  - 追加（Add row）
  - 編集（name/amount/category/note）
  - 削除（row delete）
  - （任意）並び替え（sortOrder：上下ボタン or drag）
- 保存
  - `MonthlyRepository.replaceItems(monthlyRecordId, items)`
- エラー/ローディング/空状態
- 収入タブ/支出タブ（または 2 セクション）

## Out of Scope

- 内訳 → 合計への自動集計・同期（E7/E8）
- 予算/カテゴリ集計（将来）
- テンプレ/定型内訳の呼び出し（将来）
- 月次削除（E10）

---

## Functional Requirements

### 1) 対象月（ym）と MonthlyRecord の解決

- `ym` は URL から取得（"YYYY-MM"）
- `record = MonthlyRepo.getByYm(planId, ym)`
- record が無い場合の方針（どちらか選択して仕様固定）：
  - 方針 A（推奨）：詳細画面を開いた時点で record を自動作成（空の合計で OK）
    - `MonthlyRepo.upsertByYm(planId, ym, {})` など
  - 方針 B：先に「かんたん入力」へ誘導し、record 作成後に詳細へ
    - Empty：`まずは今月の合計を入力してください` → `/months/[yyyy-mm]`

※MVP は方針 A がスムーズ。

### 2) 内訳の読み込み

- `items = MonthlyRepo.listItems(monthlyRecordId)`
- 表示は kind で分ける：
  - incomeItems = items.filter(kind==="income")
  - expenseItems = items.filter(kind==="expense")
- sortOrder 昇順で表示（未設定なら作成順）

### 3) 行の追加

- 収入/支出それぞれに「＋行追加」
- 追加行の初期値：
  - name: ""
  - amountYen: undefined（or 0）
  - category: 任意（デフォルト "未分類" でも OK）
  - sortOrder: 末尾+1
- name/amount は入力必須（保存時に検証）

### 4) 行の編集

- 編集可能フィールド（MVP 最小）：
  - name（必須）
  - amountYen（必須、>0）
  - category（任意）
  - note（任意）
- 金額入力はカンマ許容（A5 parseYenInput 利用推奨）

### 5) 行の削除

- 行右端の削除アイコン
- confirm は任意（MVP では Undo が無いので、最低限 “削除しました” toast でも OK）
  - 誤操作が多い UI なら confirm 推奨

### 6) 並び替え（任意）

- MVP 最小：上下ボタンで sortOrder 入替
- drag&drop は後回しで OK

### 7) 保存

- 保存ボタン押下で全行を検証 → OK なら replace 保存
- 検証ルール（MVP）：
  - name 必須（空はエラー）
  - amountYen は数値で >0
- `MonthlyRepo.replaceItems(monthlyRecordId, normalizedItems)`
  - id が無い行は新規 id 発行（Repo 側 or 画面側で統一）
  - kind, sortOrder を必ず保存
- 成功：
  - toast `保存しました`
  - （任意）月次一覧へ戻る
- 失敗：
  - toast `保存に失敗しました`
  - 画面は維持

---

## UI Requirements

- v0 モック準拠（収入/支出をタブ or 2 カラム/2 セクション）
- 各行は最小で「名称」「金額」「カテゴリ（任意）」「削除」
- 下部に合計サマリー（任意：表示だけ。自動集計は E7 で確定）
- ローディング：Skeleton
- エラー：Alert + リトライ

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo：
  - `MonthlyRepo.getByYm(planId, ym)`
  - `MonthlyRepo.upsertByYm(planId, ym, {})`（record 自動作成する場合）
  - `MonthlyRepo.listItems(monthlyRecordId)`
  - `MonthlyRepo.replaceItems(monthlyRecordId, items)`
- state 管理：
  - items を 1 配列で持ち、kind で分割表示するか
  - incomeItems/expenseItems を別 state で持ち、保存時にマージする
- dirty 判定（任意）：初期 items と比較して変更があれば離脱 confirm

---

## Acceptance Criteria

- [ ] 月次詳細画面を開くと既存内訳が読み込まれ表示される
- [ ] 収入内訳に行追加・編集・削除ができる
- [ ] 支出内訳に行追加・編集・削除ができる
- [ ] 保存で IndexedDB に永続化され、再訪時に復元される
- [ ] name 未入力/金額<=0 の行は保存できず、エラー表示される
- [ ] record 未作成の場合でも詳細入力を開始できる（方針 A）または適切に誘導できる（方針 B）
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 新規月 → 行追加 → 保存 → 再訪
  - 既存月 → 編集 → 保存
  - バリデーション NG（空 name/金額 0）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（MonthlyRepo：listItems/replaceItems/getByYm/upsertByYm）
- E1/E2（一覧から詳細へ遷移があると検証しやすい）
- A5（formatYen/parseYenInput：推奨）

## Follow-ups（関連チケット）

- E7. 内訳合計の自動集計（items→MonthlyRecord 合計へ反映）
- E8. かんたん入力と詳細内訳の整合方針（どちらが正？）
- E9. カテゴリ集計・固定費/変動費ビュー（将来）

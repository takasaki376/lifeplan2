# Jira チケット（D5）ダッシュボード：住宅 LCC サマリーカード（選択中タイプ＋合計/概算）＋シナリオ切替連動

## Summary

D5. ダッシュボード：住宅 LCC サマリーカード（選択中タイプ＋合計/概算）＋シナリオ切替（selectedScenario 連動）

## Issue Type

Story（または Task）

## Priority

Medium（ダッシュボード価値を上げる／住宅 LCC の導線強化）

## Background / Context

住宅はライフプランの中心要素。ダッシュボード上で「選択中の住宅タイプ」と「生涯コスト（概算）」が見えると、
前提入力・LCC 比較・見直しの行動につながる。
また本アプリはシナリオ比較（保守/標準/楽観）が前提のため、ダッシュボードで選んだシナリオ（D7）に応じて
住宅 LCC の表示値が切り替わる必要がある。

MVP は IndexedDB 永続化のため、Repository から現行 Version の住宅前提とシナリオ前提を取得し、計算して表示する。

## Goal

- ダッシュボードに「住宅 LCC サマリーカード」を表示できる
- 現行 Version の選択中住宅タイプ（isSelected=true）を表示できる
- 合計 LCC（概算）を表示できる（計算未実装の場合はプレースホルダで導線を成立）
- ダッシュボードで選んだシナリオ（selectedScenario）で計算結果が切り替わる
- 住宅 LCC 比較トップ/前提編集への導線がある

---

## In Scope

- 画面：`/plans/[planId]`（ダッシュボード）
- 状態（D7）連動：
  - Dashboard で決定された `selectedScenario` を D5 に渡して表示と計算に反映
  - URL クエリ `?scenario=` が変わると D5 も再計算される
- Repo 連携：
  - `VersionRepo.getCurrent(planId)`（現行 Version 取得）
  - `HousingRepo.listByVersion(planVersionId)`（4 タイプ取得）
  - `ScenarioRepo.getByVersion(planVersionId)`（3 シナリオ前提取得）※Repo が無い場合は Plan/Version に内包でも可
  - selected（isSelected=true）の特定
- サマリーカード UI 実装（v0 モック準拠）
- 表示分岐：
  - 住宅前提が不足/未選択/計算不可のケースを安全に表示
- 導線：
  - `住宅LCC比較へ` → `/plans/[planId]/housing`
  - `前提を編集` → `/plans/[planId]/housing/assumptions`

## Out of Scope

- LCC 詳細比較チャート（G1/G4）
- 住宅前提編集そのもの（G5〜）
- 正確な税制/補助金/売却損益の精緻モデル（MVP 外）
- 将来推移への反映（I2）
- シナリオの永続的な既定値保存（URL クエリ以外のユーザー設定）

---

## Functional Requirements

### 1) データ取得

- ダッシュボード初期化時（D1/D2 と並列で OK）：
  - `currentVersion = VersionRepo.getCurrent(planId)`
  - `housingList = HousingRepo.listByVersion(currentVersion.id)`
  - `scenarioSet = ScenarioRepo.getByVersion(currentVersion.id)`（または Version に内包された前提を取得）
- 例外：
  - currentVersion なし → カードは「現行バージョンがありません」表示＋導線（任意）
  - housingList が 0 件/不足 → カードは空状態表示＋`前提を編集`導線
  - scenarioSet が無い/不足 → base 相当のデフォルト前提で計算（warning 表示）

### 2) 選択中住宅タイプの決定

- `selectedHousing = housingList.find(h => h.isSelected)`
- selected が無い場合：
  - 表示：`住宅タイプが未選択です`
  - CTA：`住宅LCC比較へ`

### 3) シナリオ選択（D7 連動）

- D5 は `selectedScenario` を入力として受け取る（props or context）
  - 値：`conservative | base | optimistic`
- `scenarioAssumptions = scenarioSet[selectedScenario]`
- 不正値/未取得の場合：`base` にフォールバックし、`前提が不足しています（標準で表示）` を表示（任意）

### 4) 表示項目（MVP 最小）

- タイトル：`住宅LCC（概算）`
- 選択中タイプ表示（例：`選択中：高性能住宅`）
- シナリオ表示：
  - `前提：保守/標準/楽観`（selectedScenario に追従）
- 合計（概算）：
  - `総額：xx,xxx,xxx円`（formatYen）
  - `期間：35年`（固定でも OK）
- 補助表示（任意）：
  - `最終更新：YYYY/MM/DD`

### 5) 概算計算（シナリオ反映）

- `calcLccSummary(housingAssumptions, scenarioAssumptions, horizonYears=35)`
- シナリオが影響する項目（MVP 最小）：
  - 賃貸：`rentIncreaseRateAnnual` を家賃上昇に使用
  - 光熱：`utilitiesIncreaseRateAnnual` を光熱上昇に使用
  - 税/修繕/管理：`inflationRateAnnual` を年次増額に使用（任意、MVP は固定でも可）
- ただし「概算」表記を必須にする（誤解防止）

### 6) 空状態/エラー状態

- 住宅前提が不足：`住宅前提が未設定です` → `前提を編集`
- 住宅タイプ未選択：`住宅タイプが未選択です` → `住宅LCC比較へ`
- シナリオ前提が不足：
  - `シナリオ前提が不足しています（標準で表示）` → `前提を編集`（任意）
- 計算に必要な項目が欠ける（方針 A の場合）：
  - `概算を出すための前提が不足しています` → `前提を編集`

---

## UI Requirements

- v0 モック準拠のカード
- 表示優先度：
  1. selected タイプのラベル
  2. 合計（概算）大きく表示
  3. 前提（シナリオ）ラベル
  4. CTA（比較へ/前提編集）
- ローディング：Skeleton
- エラー：カード内 Alert（他カードに影響させない）

---

## Technical Notes

- `"use client"`（IndexedDB）
- D7 連動：
  - D5 は `selectedScenario` を props で受け取る（MVP 推奨）
  - 計算は `useMemo` で `selectedScenario` を依存に含める
- util（A5 推奨）：
  - `formatYen()`
- 依存 Repo：
  - `VersionRepo.getCurrent(planId)`
  - `HousingRepo.listByVersion(planVersionId)`
  - `ScenarioRepo.getByVersion(planVersionId)`（または Version 内包）
- 計算関数は将来 G9 へ置換できるように切り出す：
  - `src/lib/calc/lccSummary.ts`（D5 用の簡易版：scenarioAssumptions 対応）
  - G9 で `calcLcc()` ができたら差し替え

---

## Acceptance Criteria

- [ ] ダッシュボードに住宅 LCC サマリーカードが表示される
- [ ] 現行 Version の選択中住宅タイプが表示される（isSelected=true）
- [ ] シナリオ表示（保守/標準/楽観）が selectedScenario に追従して切り替わる
- [ ] 合計（概算）が selectedScenario に応じて切り替わる（方針 A の場合）
- [ ] 計算未実装（方針 B）の場合でも、シナリオ表示は切り替わり、プレースホルダが適切に出る
- [ ] 住宅前提が不足/未選択のとき、空状態メッセージと正しい CTA が表示される
- [ ] `住宅LCC比較へ` / `前提を編集` の導線が機能する
- [ ] ローディング/エラー表示がある
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - scenario=base/conservative/optimistic で表示が切り替わる
  - 選択中あり（数値表示/プレースホルダ）
  - 未選択
  - 前提不足（住宅/シナリオ）
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（VersionRepo / HousingRepo）
- D7（シナリオ切替状態管理：URL クエリ）
- C3（初期前提投入：4 タイプ＋ selected、3 シナリオ）
- A5（formatYen：推奨）
- （任意）G9（LCC 計算モジュール。無い場合は方針 B or 簡易計算）

## Follow-ups

- G9（LCC 計算モジュール）で合計/内訳を精緻化し、D5 はその結果を表示するだけにする
- G3（horizon 切替）と連動してダッシュボードでも期間表示を切替
- G1（住宅比較トップ）も同じ scenario クエリ仕様に統一

# Jira チケット（C1-1）プラン一覧：当月の収支/資産/負債を表示（MonthlyRecord 連携）

## Summary

C1-1. プラン一覧：当月の収支/資産/負債を表示（MonthlyRepository.getByYm 連携）

## Issue Type

Story（または Task）

## Priority

Medium（一覧の情報量向上。ただし N+1 に注意）

## Background / Context

プラン一覧で「当月の状況」が分かると、どのプランを更新すべきか判断しやすい。
当月の収支/資産/負債は月次コアデータとして扱う前提のため、MonthlyRecord から取得して表示する。

## Goal

- プラン一覧の各行で当月の「収支/資産/負債」を表示できる
- 月次未入力の場合は `—` で安全に表示し、未入力バッジとも整合する
- 表示は共通フォーマット（A5）で整形される
- パフォーマンス劣化が許容範囲である（必要なら後続で bulk 化）

---

## In Scope

- 画面：プラン一覧（C1）
- 当月キー生成：`currentYm = getCurrentYearMonth()`
- Repo 連携：
  - `MonthlyRepo.getByYm(planId, currentYm)` をプラン行表示のために呼び出す
- 表示項目（各プラン行/カード内）
  - 今月収支：`incomeTotalYen - expenseTotalYen`
  - 資産：`assetsBalanceYen`
  - 負債：`liabilitiesBalanceYen`
- 表示フォーマット：
  - `formatYen()`（A5）
  - 収支は符号で視覚表現（任意：+は緑、-は赤）
- ローディング/未入力の扱い
  - 月次取得中：Skeleton（小さめ） or `…`
  - 月次なし：`—` 表示

## Out of Scope

- 前月比/前年差分
- 月次詳細内訳の集計表示
- bulk 取得 API の追加（必要なら Follow-ups で）

---

## Functional Requirements

### 1) データ取得フロー

- Plan 一覧取得：`PlanRepo.list(...)`
- 表示対象プランの各 planId について：
  - `monthly = await MonthlyRepo.getByYm(planId, currentYm)`
- monthly が undefined の場合：
  - 収支/資産/負債は `—`
  - 入力状態は既存ロジック通り「未入力」

### 2) 値の算出

- net = (monthly.incomeTotalYen ?? 0) - (monthly.expenseTotalYen ?? 0)
- assets = monthly.assetsBalanceYen
- liabilities = monthly.liabilitiesBalanceYen
  ※ monthly が無い場合は算出しない（—）

### 3) UI 表示要件

- ラベル：
  - `今月収支` `資産` `負債`
- 表示：
  - 金額は `formatYen`
  - 収支は +/− を明示（例：`+12,000円` / `-8,000円`）

### 4) エラー/例外

- 月次取得失敗：
  - 行単位で `—` + 小さな警告（任意）または toast（一覧全体で 1 回）
- 二重取得防止：
  - 同一 planId に対して同一 ym はメモ化（useMemo/map キャッシュ）推奨

---

## Technical Notes

- `"use client"`（IndexedDB）
- パフォーマンス：
  - 初期は `Promise.all` で並列取得（表示中 N 件）
  - 取得結果は `Map<planId, MonthlyRecord | undefined>` で保持
- util（A5）：
  - `getCurrentYearMonth()`
  - `formatYen()`

---

## Acceptance Criteria

- [ ] プラン一覧の各行に「今月収支/資産/負債」が表示される
- [ ] 月次未入力のプランは `—` 表示になり、未入力バッジと矛盾しない
- [ ] 収支が income-expense で正しく計算される
- [ ] 金額が共通フォーマット（A5）で表示される
- [ ] ローディング/エラー時に UI が破綻しない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 月次あり/なしのプラン混在
  - 収支がプラス/マイナス
- [ ] lint/typecheck が通る

---

## Dependencies

- C1（プラン一覧：IndexedDB 連携）
- B5（MonthlyRepo.getByYm 実装済み）
- A5（format/getCurrentYearMonth）

## Follow-ups

- C1-2：MonthlyRepo.getByYmBulk(planIds, ym) を追加して N+1 を解消
- C1-3：表示項目のユーザー設定（将来）

# Jira チケット（E10）月次削除（confirm）＋関連内訳削除

## Summary

E10. 月次削除（confirm）＋関連内訳（MonthlyItem）削除 — 安全に月次を消して整合を保つ

## Issue Type

Story（または Task）

## Priority

High（誤入力/不要月の整理に必須）

## Background / Context

月次は継続管理の基礎データ。誤入力や不要になった月のデータを削除できる必要がある。  
ただし月次詳細（E6）で内訳（MonthlyItem）も保持するため、MonthlyRecord のみ削除するとゴミデータや不整合が発生する。  
本チケットでは confirm 付きで、record と items を一括削除する。

## Goal

- 月次を削除できる（confirm 必須）
- 紐づく内訳（incomeItems/expenseItems）も同時に削除される
- 削除後、一覧/詳細の表示が正しく更新される（未入力へ戻る）
- 失敗時はユーザーに分かる通知が出る

---

## In Scope

- 削除アクションの UI 接続
  - 月次一覧（E2）の行メニューに `削除`（destructive）
  - （任意）月次詳細（E6）のヘッダー/メニューに `削除`
- confirm ダイアログ（必須）
- Repo 連携（IndexedDB）
  - 対象月の record 特定（planId+ym）
  - record 削除
  - 関連 items 削除
  - 可能なら transaction で一括削除
- 削除後の UI 更新（再 fetch or state 更新）
- toast（成功/失敗）
- 二重送信防止（削除中 disabled）

## Out of Scope

- Undo（取り消し）
- ゴミ箱（論理削除）
- 監査ログ

---

## Functional Requirements

### 1) 削除対象の特定

- 入力：`planId` と `ym`（YYYY-MM）
- `record = MonthlyRepo.getByYm(planId, ym)`
- record が存在しない場合：
  - toast：`この月のデータはありません`
  - 何もしない（一覧はそのまま）

### 2) confirm ダイアログ

- Title：`この月のデータを削除しますか？`
- Description：`この操作は取り消せません。内訳（収入/支出）も削除されます。`
- 表示（任意だが推奨）：
  - 対象月：`YYYY年M月`
  - （もし取得できれば）かんたん合計：収入/支出
- Buttons：
  - `キャンセル`
  - `削除`（destructive）

### 3) 削除処理（record + items）

- 推奨：Repo に一括削除メソッドを用意
  - `MonthlyRepo.deleteByYm(planId, ym)`
    - 内部で `record` を取得し、同一 tx で items → record の順に削除
- 代替：UI 側で段階実行（ただし tx 推奨）
  - `items = MonthlyRepo.listItems(record.id)`（任意、件数確認用）
  - `MonthlyRepo.deleteItemsByRecordId(record.id)`
  - `MonthlyRepo.deleteRecord(record.id)`

### 4) UI 更新

- 月次一覧（E1/E2）から削除した場合：
  - 削除後、対象月は `未入力` として表示される
  - 入力済みフィルタから消える
- 月次詳細（E6）から削除した場合（任意）：
  - 成功後に `/plans/[planId]/months` に遷移
  - toast：`削除しました`

### 5) ローディング/エラー

- 削除中：
  - confirm の `削除` ボタンを disabled + spinner
- 成功：
  - toast：`削除しました`
- 失敗：
  - toast：`削除に失敗しました`
  - 可能ならダイアログは開いたまま（再試行可能）

---

## UI Requirements

- shadcn/ui:
  - `AlertDialog`（confirm）
  - `DropdownMenu`（一覧の行メニュー）
  - `Button` destructive
  - `toast`（sonner 等）
- 削除導線は誤タップ防止のためメニュー内推奨
- モバイルでも押しやすい

---

## Technical Notes

- `"use client"`（IndexedDB）
- Repo：
  - `MonthlyRepo.getByYm(planId, ym)`
  - `MonthlyRepo.deleteByYm(planId, ym)`（推奨）
  - または `deleteItemsByRecordId` + `deleteRecord`
- IndexedDB transaction 推奨：
  - objectStore: `monthlyRecords`, `monthlyItems`
  - tx: readwrite
  - items 削除 → record 削除（参照整合のため）
- 削除後の再描画：
  - 方針 A：再 fetch（安全）
  - 方針 B：state から除外/未入力化（高速）

---

## Acceptance Criteria

- [ ] 月次一覧（または詳細）から削除アクションが実行できる
- [ ] confirm ダイアログが必ず表示される
- [ ] 削除すると MonthlyRecord が IndexedDB から削除される
- [ ] 関連する MonthlyItem（内訳）が全て削除される
- [ ] 削除後、一覧で対象月が「未入力」になる（入力済みフィルタから消える）
- [ ] 成功/失敗 toast が表示される
- [ ] 削除中は二重送信できない
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - 入力済み月を削除 → 未入力化
  - 内訳あり月を削除 →items も消える
  - キャンセル → 何も変わらない
  - 失敗（Repo throw）→toast→ 再試行可能
- [ ] lint/typecheck が通る

---

## Dependencies

- B5（MonthlyRepo 実装）
- E1/E2（月次一覧に削除導線を付ける場合）
- E6（内訳が存在するケースの検証に必要）

## Follow-ups

- Undo（取り消し）
- 論理削除（アーカイブ）導入

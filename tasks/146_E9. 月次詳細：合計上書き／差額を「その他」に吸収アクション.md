# Jira チケット（E9）月次詳細：差額を「その他（調整）」に吸収して合計一致（統一仕様）

## Summary

E9. 月次詳細：差額を「その他（調整）」内訳行に吸収して合計を一致させる（統一）

## Issue Type

Story（または Task）

## Priority

High（不整合解消の運用を完成させる）

## Background / Context

E8 で「内訳合計 vs かんたん合計（MonthlyRecord）」の差分を表示できるが、実運用では “一致させる操作” が必要。
本チケットでは対応方針を **「差額を『その他（調整）』行として内訳側に吸収し、かんたん合計と一致させる」** に統一する。

## Goal

- 差分があるとき、ワンクリックで一致させられる
- 実行後、E8 の差分が 0（一致）になる
- 保存・再訪で一致状態が維持される（IndexedDB）

---

## In Scope

- 月次詳細（`/plans/[planId]/months/[yyyy-mm]/detail`）の差分サマリー領域にアクション追加
- アクション実装（Repo 連携）
  - MonthlyRecord 取得：`MonthlyRepo.getByYm(planId, ym)`（record が無ければ作成）
  - MonthlyItem 取得：`MonthlyRepo.listItems(recordId)`
  - MonthlyItem 保存：`MonthlyRepo.replaceItems(recordId, items)`（MVP は全置換）
- 「その他（調整）」行の追加/更新ルール実装
- ローディング、失敗 toast、二重送信防止

## Out of Scope

- MonthlyRecord（かんたん合計）を内訳で上書きする同期
- 合計 → 内訳を複数行に自動分解生成
- Undo（取り消し）

---

## Spec（統一仕様）

### 1) 差分定義（E8 と同一）

- incomeItemsTotal = sum(items where kind="income")
- expenseItemsTotal = sum(items where kind="expense")
- easyIncome = record.incomeTotalYen ?? 0
- easyExpense = record.expenseTotalYen ?? 0
- deltaIncome = easyIncome - incomeItemsTotal
- deltaExpense = easyExpense - expenseItemsTotal

### 2) 「その他（調整）」行の定義（固定キー）

- name: "その他（調整）"
- category: "その他"
- kind: "income" または "expense"
- expenseNature（支出のみ）: "variable"（デフォルト）
- amountYen: 調整金額（後述）

### 3) 吸収アクション（収入/支出/両方）

- 表示条件：
  - deltaIncome != 0 のとき「収入差額を吸収」
  - deltaExpense != 0 のとき「支出差額を吸収」
  - 両方非 0 なら「両方吸収」も表示（任意）
- 実行内容（共通）：
  1. 対象 kind の既存「その他（調整）」行を検索
  2. 存在する場合：amountYen = amountYen + delta
  3. 存在しない場合：末尾に新規行追加（sortOrder=max+1、amountYen=delta）
  4. items を保存（replaceItems）
  5. 再計算して差分が 0 になったことを確認し UI 更新
- delta が負の場合も許容：
  - “一致させる”ことを優先し、調整行は amountYen が負になる可能性がある
  - 表示上は「調整（±）」としてバッジを付ける（任意）

### 4) バリデーションとの整合（重要）

- 通常内訳行：amountYen > 0（E6 のルール維持）
- 「その他（調整）」行：amountYen != 0 を許容（負数 OK）
  - これにより delta<0 のケースでも一致可能

### 5) UI/UX

- 差分サマリー内に説明文：
  - `差額を「その他（調整）」にまとめて、合計（かんたん入力）と一致させます。`
- ボタン：
  - `収入差額を吸収`
  - `支出差額を吸収`
  - `両方吸収`（任意）
- 実行中：disabled + spinner
- 成功 toast：`差額を吸収して一致させました`
- 失敗 toast：`吸収に失敗しました`

---

## Acceptance Criteria

- [ ] 差分がある場合、吸収ボタンが表示される
- [ ] 吸収を実行すると「その他（調整）」行が追加または更新される
- [ ] 実行後、内訳合計がかんたん合計と一致し、差分が 0 になる
- [ ] delta が負のケースでも（調整行に負額を許容して）一致できる
- [ ] 保存後に再訪しても一致状態が維持される
- [ ] toast 表示と二重送信防止ができている
- [ ] lint/typecheck が通る

## Definition of Done

- [ ] PR 作成＆レビュー完了
- [ ] 手動テスト手順が PR に記載
  - delta>0：吸収 → 一致
  - delta<0：吸収 → 一致（調整行が負になる）
  - 既存の調整行がある：加算更新される
- [ ] lint/typecheck が通る

---

## Dependencies

- E6（月次詳細：内訳 CRUD）
- E8（差分表示）
- E7（カテゴリ/固定変動：category="その他" を使用）
- B5（MonthlyRepo）
- ★E6 のバリデーション更新（調整行のみ amountYen≠0 を許容）

## Follow-ups

- 調整行の見た目（常に下部固定、折りたたみ）
- Undo（取り消し）
